<!--DOCTYPE html-->
<html>
<head>
    <title>LIVE Sports From MsM</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        body {
            background-color: #0d1a26;
            color: #e0e0e0;
            font-family: 'Segoe UI', Arial, sans-serif;
            margin: 0;
            padding: 0;
            overflow-x: auto;
        }

        /* Loading Overlay Styles */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            color: #00bfff;
            font-size: 24px;
            font-weight: bold;
        }

        .loading-overlay .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #00bfff;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Internet Status Overlay Styles */
        .internet-status-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10000; /* Higher than other overlays */
            color: #ff3366; /* Red color for warning */
            font-size: 28px;
            font-weight: bold;
            text-align: center;
            gap: 20px;
            display: none; /* Hidden by default */
        }

        .internet-status-overlay .icon {
            font-size: 80px;
            color: #ff3366;
        }

        .internet-status-overlay .message {
            font-size: 1.2em;
            color: #e0e0e0;
        }


        .main-app-container {
            max-width: 100%;
            width: 100%;
            margin: 0;
            background-color: #1a2a3a;
            border-radius: 0;
            overflow: auto;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .app-header {
            background-color: #2c3e50;
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: #fff;
            font-weight: bold;
            font-size: 20px;
            border-bottom: 1px solid #3d5a71;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            flex-shrink: 0;
        }

        .app-header .logo {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            position: relative;
        }

        .app-header .logo img {
            height: 35px;
            border-radius: 6px;
        }

        .header-icons {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .translate-icon, .category-icon, .bookmark-icon, .search-icon, .add-link-icon, .event-icon {
            color: #00bfff;
            font-size: 24px;
            cursor: pointer;
            padding: 5px;
            border-radius: 5px;
            transition: background-color 0.3s ease;
        }

        .translate-icon:hover, .category-icon:hover, .bookmark-icon:hover, .search-icon:hover, .add-link-icon:hover, .event-icon:hover {
            background-color: rgba(0, 191, 255, 0.2);
        }
        
        .bookmark-icon.active {
            color: #ffcc00;
        }


        .video-section {
            position: relative;
            width: 100%;
            padding-bottom: 56.25%;
            background-color: #000;
            overflow: auto;
            flex-shrink: 0;
        }

        .video-section video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            background-color: #000;
        }

        .video-section iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: none;
            display: none;
        }

        /* Intro Video Overlay */
        .intro-video-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
            display: none; /* Hidden by default */
        }

        .intro-video-overlay video {
            position: relative; /* Changed from absolute for easier positioning */
            width: 100%;
            height: 100%;
            object-fit: contain; /* Ensure video fits within the container */
            background-color: black;
        }

        .intro-video-overlay .skip-button {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background-color: rgba(0, 0, 0, 0.6);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            z-index: 101; /* Above the video */
            display: none; /* Hidden until ready to skip */
        }

        /* Custom Ad Button Styles */
        .ad-custom-button {
            background-color: #00bfff;
            color: #0d1a26;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            font-size: 16px;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        .ad-custom-button:hover {
            background-color: #0099cc;
            transform: translateY(-2px);
        }


        .video-details {
            padding: 8px 15px;
            background-color: #1a2a3a;
            border-bottom: 1px solid #3d5a71;
            flex-shrink: 0;
        }
        
        .video-details-top-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 3px;
        }

        .video-details .main-title {
            font-size: 16px;
            font-weight: bold;
            color: #e0e0e0;
            margin-bottom: 0;
            flex-grow: 1;
            white-space: nowrap;
            overflow: auto;
            text-overflow: ellipsis;
        }

        .video-details .title-bookmark-icon {
            color: #a0a0a0;
            font-size: 18px;
            cursor: pointer;
            margin-left: 10px;
            transition: color 0.2s ease;
            flex-shrink: 0;
        }
        
        .video-details .title-bookmark-icon.bookmarked {
            color: #ffcc00;
        }

        .video-details .views-info {
            font-size: 12px;
            color: #a0a0a0;
            text-align: left;
            margin-top: 5px;
        }

        .actions-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px 10px;
            background-color: #1a2a3a;
            border-top: 1px solid #3d5a71;
            flex-shrink: 0;
        }

        .action-group {
            display: flex;
            align-items: center;
            border-radius: 20px;
            background-color: rgba(61, 90, 113, 0.2);
        }

        .action-group .action-button {
            background-color: transparent;
            color: #e0e0e0;
            padding: 5px 8px;
            border-radius: 0;
            font-weight: 600;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            box-shadow: none;
            min-width: unset;
        }

        .action-group .action-button:first-child {
            border-top-left-radius: 20px;
            border-bottom-left-radius: 20px;
        }

        .action-group .action-button:last-child {
            border-top-right-radius: 20px;
            border-bottom-right-radius: 20px;
        }

        .action-group .action-button.has-border {
            border-right: 1px solid rgba(61, 90, 113, 0.4);
            padding-right: 8px;
            margin-right: -1px;
        }

        .action-group .action-button i {
            font-size: 16px;
            margin-bottom: 0;
        }

        .action-button.like-btn i {
            color: #00bfff;
        }
        .action-button.dislike-btn i {
            color: #a0a0a0;
        }
        .action-button.share-btn i {
            color: #00bfff;
        }
        .action-button.online-btn i {
            color: #ff3366;
        }
        .action-button.chat-btn i {
            color: #28a745;
        }
        .action-button.bookmark-toggle-btn i {
            color: #a0a0a0;
        }
        .action-button.bookmark-toggle-btn.bookmarked i {
            color: #ffcc00;
        }

        .action-button.profile-btn i {
            color: #f0ad4e;
        }


        .action-button:hover {
            background-color: rgba(61, 90, 113, 0.4);
            transform: none;
            box-shadow: none;
        }
        
        .action-button span {
            font-family: 'Roboto', 'Segoe UI', Arial, sans-serif;
            font-weight: 500;
            color: #e0e0e0;
        }


        .chat-fullscreen-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.95);
            z-index: 1500;
            display: none;
            flex-direction: column;
            justify-content: flex-start;
            padding: 20px;
            box-sizing: border-box;
        }

        .chat-fullscreen-header {
            display: flex;
            align-items: center;
            padding-bottom: 15px;
            margin-bottom: 15px;
            border-bottom: 1px solid #3d5a71;
            color: #00bfff;
            font-size: 24px;
            font-weight: bold;
            flex-wrap: wrap;
        }

        .chat-fullscreen-header .chat-header-tabs {
            flex-grow: 1;
            display: flex;
            justify-content: flex-start;
            gap: 15px;
        }


        .chat-fullscreen-close {
            color: #e0e0e0;
            font-size: 28px;
            cursor: pointer;
            padding: 5px;
            transition: color 0.2s ease;
            margin-left: auto;
        }

        .chat-fullscreen-close:hover {
            color: #ff3366;
        }
        
        .active-users-display {
            display: none;
            align-items: center;
            gap: 5px;
            margin-left: 10px;
        }

        .active-user-icon-small {
            width: 25px;
            height: 25px;
            border-radius: 50%;
            object-fit: cover;
            background-color: #3a4b5d;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #e0e0e0;
            font-size: 14px;
            position: relative;
        }

        .active-user-icon-small img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }


        .chat-messages {
            height: auto;
            flex-grow: 1;
            overflow-y: auto;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 0px;
            display: flex;
            flex-direction: column-reverse;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.2);
        }

        .chat-message {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            margin-bottom: 10px;
            line-height: 1.5;
            padding: 10px 15px;
            border-radius: 20px;
            max-width: 85%;
            word-wrap: break-word;
            overflow-wrap: break-word;
            word-break: break-all;
            font-size: 14.5px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .chat-avatar {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            overflow: hidden;
            background-color: #3a4b5d;
            flex-shrink: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            cursor: pointer;
        }

        .chat-avatar img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }

        .chat-avatar .fa-user-circle {
            font-size: 20px;
            color: #e0e0e0;
        }
        
        .online-indicator {
            position: absolute;
            bottom: 0;
            right: 0;
            width: 10px;
            height: 10px;
            background-color: #28a745;
            border-radius: 50%;
            border: 2px solid #0d1a26;
            box-sizing: border-box;
        }
        
        .offline-indicator { 
            position: absolute;
            bottom: 0;
            right: 0;
            width: 10px;
            height: 10px;
            background-color: #a0a0a0;
            border-radius: 50%;
            border: 2px solid #0d1a26;
            box-sizing: border-box;
        }


        .chat-message .message-content {
            flex-grow: 1;
            word-wrap: break-word;
            overflow-wrap: break-word;
            word-break: break-all;
        }


        .chat-message.my-message {
            align-self: flex-end;
            background-color: #007bff;
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 5px;
            flex-direction: row-reverse;
        }

        .chat-message.my-message .chat-avatar {
            margin-left: 0;
        }


        .chat-message.other-message {
            align-self: flex-start;
            background-color: #3a4b5d;
            color: #e0e0e0;
            margin-right: auto;
            border-bottom-left-radius: 5px;
        }

        .chat-message .user-name {
            font-weight: bold;
            color: #00bfff;
            margin-right: 8px;
            display: inline;
        }
        
        .chat-message .timestamp {
            font-size: 0.7em;
            color: #a0a0a0;
            margin-left: 10px;
            display: inline;
        }

        .chat-message.my-message .user-name {
            color: #b3d9ff;
        }
        .chat-message.my-message .timestamp {
            color: #cce0ff;
        }

        .message-status {
            font-size: 0.65em;
            color: rgba(255, 255, 255, 0.7);
            text-align: right;
            margin-top: 3px;
            font-weight: normal;
            display: block;
        }
        .message-status .fa-check-double {
            color: #28a745;
        }


        .chat-input-container {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 15px;
            background-color: #1a2a3a;
            border-top: 1px solid #3d5a71;
            position: relative;
        }

        .chat-input-container input[type="text"] {
            flex-grow: 1;
            padding: 12px 45px 12px 15px;
            border: 1px solid #3d5a71;
            border-radius: 8px;
            background-color: #2c3e50;
            color: #e0e0e0;
            font-size: 15px;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.2);
        }

        .chat-input-container input[type="text"]::placeholder {
            color: #a0a0a0;
        }

        .chat-input-container .send-icon {
            position: absolute;
            right: 25px;
            color: #00bfff;
            font-size: 18px;
            cursor: pointer;
            transition: color 0.2s ease;
        }

        .chat-input-container .send-icon:hover {
            color: #0099cc;
        }


        .username-overlay {
            display: none !important;
        }

        .username-input-box {
            background-color: #1a2a3a;
            padding: 35px;
            border-radius: 15px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.6);
            text-align: center;
            max-width: 90%;
            border: 1px solid #3d5a71;
        }

        .username-input-box h2 {
            color: #00bfff;
            margin-bottom: 25px;
            font-size: 24px;
        }

        .username-input-box input[type="text"] {
            width: calc(100% - 28px);
            padding: 14px;
            margin-bottom: 20px;
            border: 1px solid #3d5a71;
            border-radius: 8px;
            background-color: #2c3e50;
            color: #e0e0e0;
            font-size: 17px;
        }

        .username-input-box input[type="text"]::placeholder {
            color: #a0a0a0;
        }

        .username-input-box button {
            background-color: #00bfff;
            color: #0d1a26;
            border: none;
            padding: 14px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            font-size: 17px;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        .username-input-box button:hover {
            background-color: #0099cc;
            transform: translateY(-1px);
        }

        .add-link-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.95);
            display: none;
            justify-content: center;
            align-items: flex-start;
            padding-top: 50px;
            z-index: 2000;
        }

        .add-link-box-container {
            background-color: #1a2a3a;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.6);
            text-align: center;
            max-width: 500px;
            width: 90%;
            border: 1px solid #3d5a71;
            position: relative;
        }

        .add-link-box-container h2 {
            color: #00bfff;
            margin-bottom: 20px;
            font-size: 22px;
        }

        .add-link-box-container input[type="text"] {
            width: calc(100% - 28px);
            padding: 12px 15px;
            margin-bottom: 15px;
            border: 1px solid #3d5a71;
            border-radius: 8px;
            background-color: #2c3e50;
            color: #e0e0e0;
            font-size: 16px;
        }

        .add-link-box-container input[type="text"]::placeholder {
            color: #a0a0a0;
        }

        .add-link-box-container button {
            background-color: #00bfff;
            color: #0d1a26;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            font-size: 15px;
            transition: background-color 0.3s ease;
            box-shadow: 0 4 relentlesslyrgba(0, 0, 0, 0.3);
        }

        .add-link-box-container button:hover {
            background-color: #0099cc;
        }

        .add-link-close-btn {
            position: absolute;
            top: 10px;
            right: 15px;
            color: #e0e0e0;
            font-size: 28px;
            cursor: pointer;
            transition: color 0.2s ease;
        }

        .add-link-close-btn:hover {
            color: #ff3366;
        }

        .category-menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.95);
            z-index: 1000;
            display: none;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            padding: 20px;
            box-sizing: border-box;
            overflow-y: auto;
        }

        .category-menu-overlay.open {
            display: flex;
        }

        .category-menu-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            max-width: 800px;
            padding-bottom: 15px;
            margin-bottom: 20px;
            border-bottom: 1px solid #3d5a71;
            color: #00bfff;
            font-size: 24px;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .category-menu-close {
            color: #e0e0e0;
            font-size: 28px;
            cursor: pointer;
            padding: 5px;
            transition: color 0.2s ease;
        }

        .category-menu-close:hover {
            color: #ff3366;
        }

        .category-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 15px;
            list-style: none;
            padding: 0;
            margin: 0;
            width: 100%;
            max-width: 800px;
            justify-content: center;
        }

        .category-list li {
            background-color: #2c3e50;
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            text-align: center;
            padding: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 120px;
        }

        .category-list li:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4);
        }
        
        .category-list li .category-icon-display {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 8px;
            background-color: #3d5a71;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #00bfff;
            font-size: 24px;
            flex-shrink: 0;
        }

        .category-list li .category-icon-display img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }

        .category-list li .category-name {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            width: 100%;
        }


        .remove-category-btn {
            background: none;
            border: none;
            color: #ff6b6b;
            font-size: 18px;
            cursor: pointer;
            margin-left: 10px;
            padding: 5px;
            transition: color 0.2s ease;
            display: none;
        }

        .remove-category-btn:hover {
            color: #e0e0e0;
        }


        .channel-list-titles {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            padding: 10px 15px 0;
            background-color: #1a2a3a;
            border-bottom: 1px solid #3d5a71;
            flex-shrink: 0;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .channel-list-titles h3 {
            color: #e0e0e0;
            font-size: 18px;
            margin: 0;
            padding: 8px 12px;
            cursor: pointer;
            border-radius: 8px 8px 0 0;
            background-color: rgba(44, 71, 98, 0.4);
            transition: background-color 0.3s ease, color 0.3s ease;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .channel-list-titles h3:hover {
            background-color: rgba(44, 71, 98, 0.6);
        }

        .channel-list-titles h3.active-title {
            background-color: #3d5a71;
            color: #00bfff;
            font-weight: bold;
        }

        .channel-list-titles h3 .remove-custom-m3u-btn {
            background: none;
            border: none;
            color: #ff6b6b;
            font-size: 16px;
            cursor: pointer;
            margin-left: 5px;
            padding: 0;
            transition: color 0.2s ease;
        }

        .channel-list-titles h3 .remove-custom-m3u-btn:hover {
            color: #e0e0e0;
        }

        .all-channels-section {
            background-color: #1a2a3a;
            padding: 15px 20px;
            border-top: none;
            flex-grow: 1;
            overflow-y: auto;
        }

        .all-channels-section h3.section-header {
            display: none;
        }

        .all-channel-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 15px;
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .all-channel-item {
            background-color: #2c3e50;
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            text-align: center;
            padding: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .all-channel-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4);
        }

        .all-channel-item .channel-icon-small {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 8px;
            background-color: #3d5a71;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #e0e0e0;
            font-size: 24px;
        }

        .all-channel-item .channel-name-small {
            font-size: 14px;
            color: #e0e0e0;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            width: 100%;
        }

        .search-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.95);
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding-top: 50px;
            z-index: 2000;
            display: none;
        }

        .search-box-container {
            background-color: #1a2a3a;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.6);
            text-align: center;
            max-width: 600px;
            width: 90%;
            border: 1px solid #3d5a71;
            position: relative;
        }

        .search-box-container h2 {
            color: #00bfff;
            margin-bottom: 20px;
            font-size: 22px;
        }

        .search-input-wrapper {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .search-box-container input[type="text"] {
            flex-grow: 1;
            padding: 12px 15px;
            border: 1px solid #3d5a71;
            border-radius: 8px;
            background-color: #2c3e50;
            color: #e0e0e0;
            font-size: 16px;
        }

        .search-box-container input[type="text"]::placeholder {
            color: #a0a0a0;
        }

        .search-box-container button {
            background-color: #00bfff;
            color: #0d1a26;
            border: none;
            padding: 12px 18px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            font-size: 15px;
            transition: background-color 0.3s ease;
            box-shadow: 0 4 relentlesslyrgba(0, 0, 0, 0.3);
        }

        .search-box-container button:hover {
            background-color: #0099cc;
        }

        .search-results-list {
            list-style: none;
            padding: 0;
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
            border-top: 1px solid #3d5a71;
            padding-top: 10px;
        }

        .search-results-list li {
            padding: 10px 15px;
            border-bottom: 1px solid #2c3e50;
            cursor: pointer;
            transition: background-color 0.2s ease;
            text-align: left;
            display: flex;
            align-items: center;
            gap: 10px;
            position: relative;
        }

        .search-results-list li:hover {
            background-color: rgba(61, 90, 113, 0.3);
        }

        .search-results-list li:last-child {
            border-bottom: none;
        }

        .search-results-list li .channel-icon-small {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            object-fit: cover;
            background-color: #3d5a71;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #e0e0e0;
            font-size: 14px;
            flex-shrink: 0;
        }

        .search-results-list li .channel-name-search {
            font-size: 16px;
            color: #e0e0e0;
            font-weight: 500;
            flex-grow: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            width: 100%;
        }

        .bookmark-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.95);
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding-top: 50px;
            z-index: 2000;
            display: none;
        }

        .bookmark-list-container {
            background-color: #1a2a3a;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.6);
            text-align: center;
            max-width: 600px;
            width: 90%;
            border: 1px solid #3d5a71;
            position: relative;
        }

        .bookmark-list-container h2 {
            color: #00bfff;
            margin-bottom: 20px;
            font-size: 22px;
        }

        .bookmark-close-btn {
            position: absolute;
            top: 10px;
            right: 15px;
            color: #e0e0e0;
            font-size: 28px;
            cursor: pointer;
            transition: color 0.2s ease;
        }

        .bookmark-close-btn:hover {
            color: #ff3366;
        }

        .bookmark-channels-list {
            list-style: none;
            padding: 0;
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
            border-top: 1px solid #3d5a71;
            padding-top: 10px;
        }

        .bookmark-channels-list li {
            padding: 10px 15px;
            border-bottom: 1px solid #2c3e50;
            cursor: pointer;
            transition: background-color 0.2s ease;
            text-align: left;
            display: flex;
            align-items: center;
            gap: 10px;
            position: relative;
        }

        .bookmark-channels-list li:hover {
            background-color: rgba(61, 90, 113, 0.3);
        }

        .bookmark-channels-list li:last-child {
            border-bottom: none;
        }

        .bookmark-channels-list li .channel-icon-small {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            object-fit: cover;
            background-color: #3d5a71;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #e0e0e0;
            font-size: 14px;
            flex-shrink: 0;
        }

        .bookmark-channels-list li .channel-name-bookmark {
            font-size: 16px;
            color: #e0e0e0;
            font-weight: 500;
            flex-grow: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            width: 100%;
        }

        .remove-bookmark-btn {
            background: none;
            border: none;
            color: #ff6b6b;
            font-size: 20px;
            cursor: pointer;
            margin-left: 10px;
            padding: 5px;
            transition: color 0.2s ease;
        }

        .remove-bookmark-btn:hover {
            color: #e0e0e0;
        }

        .event-fullscreen-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.95);
            z-index: 1500;
            display: none;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            padding: 20px;
            box-sizing: border-box;
            overflow-y: auto;
        }

        .event-fullscreen-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            max-width: 600px;
            padding-bottom: 15px;
            margin-bottom: 20px;
            border-bottom: 1px solid #3d5a71;
            color: #00bfff;
            font-size: 24px;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .event-fullscreen-close {
            color: #e0e0e0;
            font-size: 28px;
            cursor: pointer;
            padding: 5px;
            transition: color 0.2s ease;
        }

        .event-fullscreen-close:hover {
            color: #ff3366;
        }

        .event-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            width: 100%;
            max-width: 900px;
            padding-bottom: 20px;
            justify-content: center;
        }

        .event-card {
            background: linear-gradient(145deg, #1f3548, #111e2b);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.6);
            border: 2px solid #ffcc00;
            text-align: center;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            min-height: 260px;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .event-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.7);
        }

        .event-card::before {
            content: '';
            position: absolute;
            top: -20px;
            left: -20px;
            width: 80px;
            height: 80px;
            background: radial-gradient(circle, rgba(0, 191, 255, 0.3) 0%, transparent 70%);
            border-radius: 50%;
            filter: blur(10px);
            transform: rotate(45deg);
        }

        .event-card::after {
            content: '';
            position: absolute;
            bottom: -20px;
            right: -20px;
            width: 80px;
            height: 80px;
            background: radial-gradient(circle, rgba(255, 204, 0, 0.3) 0%, transparent 70%);
            border-radius: 50%;
            filter: blur(10px);
            transform: rotate(45deg);
        }


        .event-team-display {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            gap: 10px;
        }

        .event-team {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1;
        }

        .event-team img {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 8px;
            border: 2px solid #00bfff;
            box-shadow: 0 0 10px rgba(0, 191, 255, 0.5);
        }

        .event-team-name {
            font-size: 16px;
            font-weight: 600;
            color: #e0e0e0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100px;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5);
        }

        .event-vs {
            font-size: 26px;
            font-weight: bold;
            color: #ffcc00;
            margin: 0 10px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.7);
        }

        .event-title {
            font-size: 1.3em;
            font-weight: 700;
            color: #e0e0e0;
            margin-top: 15px;
            flex-grow: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            text-shadow: 0 1px 4px rgba(0, 0, 0, 0.6);
        }

        .event-countdown {
            font-size: 1.6em;
            font-weight: bold;
            color: #00bfff;
            margin-top: 15px;
            letter-spacing: 0.8px;
            text-shadow: 0 1px 4px rgba(0, 0, 0, 0.6);
        }

        .event-countdown.finished {
            color: #28a745;
        }

        .watch-match-btn {
            background-color: #28a745;
            color: #ffffff;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            font-size: 1.1em;
            margin-top: 20px;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.4);
            display: block;
            width: calc(100% - 20px);
        }

        .watch-match-btn:hover {
            background-color: #218838;
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.5);
        }

        .watch-match-btn:disabled {
            background-color: #555;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .no-event-message {
            color: #a0a0a0;
            font-size: 1.1em;
            text-align: center;
            padding: 20px;
            width: 100%;
        }

        .domain-error-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #0d1a26;
            color: #e0e0e0;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 20px;
            box-sizing: border-box;
            z-index: 9999;
            display: none;
        }

        .domain-error-overlay h1 {
            color: #ff3366;
            margin-bottom: 20px;
        }

        .domain-error-overlay p {
            font-size: 1.2em;
            max-width: 500px;
            line-height: 1.5;
        }

        .profile-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.95);
            display: none;
            justify-content: center;
            align-items: flex-start;
            padding-top: 50px;
            z-index: 2000;
        }

        .profile-box-container {
            background-color: #1a2a3a;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.6);
            text-align: center;
            max-width: 450px;
            width: 90%;
            border: 1px solid #3d5a71;
            position: relative;
        }

        .profile-close-btn {
            position: absolute;
            top: 10px;
            right: 15px;
            color: #e0e0e0;
            font-size: 28px;
            cursor: pointer;
            transition: color 0.2s ease;
        }

        .profile-close-btn:hover {
            color: #ff3366;
        }

        .profile-box-container h2 {
            color: #00bfff;
            margin-bottom: 20px;
            font-size: 24px;
            font-weight: bold;
        }

        .profile-box-container input[type="email"],
        .profile-box-container input[type="password"],
        .profile-box-container input[type="text"] {
            width: calc(100% - 28px);
            padding: 12px 15px;
            margin-bottom: 15px;
            border: 1px solid #3d5a71;
            border-radius: 8px;
            background-color: #2c3e50;
            color: #e0e0e0;
            font-size: 16px;
        }

        .profile-box-container input[type="email"]::placeholder,
        .profile-box-container input[type="password"]::placeholder,
        .profile-box-container input[type="text"]::placeholder {
            color: #a0a0a0;
        }
        
        .profile-box-container .form-group {
            position: relative;
            margin-bottom: 15px;
        }

        .profile-box-container button {
            background-color: #00bfff;
            color: #0d1a26;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            font-size: 16px;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            width: 100%;
            box-sizing: border-box;
        }
        
        .profile-box-container .progress-bar, .profile-box-container .success-message {
            text-align: center;
            margin-top: 15px;
            padding: 10px;
            border-radius: 8px;
            font-weight: bold;
            display: none;
        }

        .profile-box-container .progress-bar {
            background-color: #00bfff;
            color: #0d1a26;
        }

        .profile-box-container .success-message {
            background-color: #28a745;
            color: #ffffff;
        }

        .fa-spinner {
            animation: fa-spin 1s infinite linear;
        }
        @keyframes fa-spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }


        .profile-box-container button:hover {
            background-color: #0099cc;
            transform: translateY(-1px);
        }

        .profile-box-container p {
            margin-top: 15px;
            font-size: 14px;
            color: #a0a0a0;
        }

        .profile-box-container p span {
            font-weight: bold;
        }
        
        /* Updated styles for clickable text */
        .profile-action-text {
            color: #00bfff; /* Blue for clickable text */
            cursor: pointer;
            font-size: 0.85em; /* Slightly larger than original small buttons */
            margin-left: 8px;
            text-decoration: underline; /* Indicate clickability */
            transition: color 0.2s ease;
            display: inline-block;
            vertical-align: middle;
        }

        .profile-action-text:hover {
            color: #0099cc; /* Darker blue on hover */
        }

        #userProfileContainer p {
            text-align: left;
            margin-bottom: 10px;
            color: #e0e0e0;
            font-size: 1.1em;
            display: flex; /* Ensure content and button stay in one line */
            align-items: center; /* Vertically align items */
        }
        #userProfileContainer p strong {
            color: #00bfff;
            display: inline-block;
            min-width: 80px;
        }
        #profilePremiumStatus { color: #00ff00; }
        #profileBanStatus { color: #ff0000; }
        .premium-status-icon {
            color: #ffcc00;
            margin-left: 5px;
        }

        .profile-image-container {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            overflow: hidden;
            margin: 0 auto 20px auto;
            background-color: #3a4b5d;
            display: flex;
            justify-content: center;
            align-items: center;
            border: 2px solid #00bfff;
            box-shadow: 0 0 10px rgba(0, 191, 255, 0.5);
        }

        .profile-image-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: none;
        }

        .profile-image-container .fa-user-circle {
            font-size: 60px;
            color: #e0e0e0;
        }

        #premiumStatusHeader {
            font-size: 0.7em;
            font-weight: bold;
            color: #ffcc00;
            margin-top: -5px;
            text-shadow: 0 0 5px rgba(255, 204, 0, 0.5);
            display: none;
        }

        .user-chat-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.95);
            z-index: 1600;
            display: none;
            flex-direction: column;
            justify-content: flex-start;
            padding: 20px;
            box-sizing: border-box;
        }

        .user-chat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 15px;
            margin-bottom: 15px;
            border-bottom: 1px solid #3d5a71;
            color: #00bfff;
            font-size: 24px;
            font-weight: bold;
        }

        .user-chat-header-info {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 0;
            margin-left: 10px;
        }

        .user-chat-back-arrow {
            font-size: 24px;
            margin-right: 10px;
            cursor: pointer;
            transition: color 0.2s ease;
            color: #00bfff;
        }
        .user-chat-back-arrow:hover {
            color: #fff;
        }

        .user-chat-header-avatar-container {
            position: relative;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            overflow: hidden;
            background-color: #3a4b5d;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-shrink: 0;
        }

        .user-chat-header-avatar-container img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }

        .user-chat-header-avatar-container .fa-user-circle {
            font-size: 24px;
            color: #e0e0e0;
        }

        .user-chat-header-name {
            font-size: 20px;
            color: #e0e0e0;
            margin-bottom: 2px;
        }

        .user-chat-header-status {
            font-size: 0.7em;
            color: #a0a0a0;
            font-weight: normal;
            margin-top: -5px;
        }
        .user-chat-header-status.active-now {
            color: #28a745;
        }
        .user-chat-header-status.active-ago {
            color: #f0ad4e;
        }
        .user-chat-header-status.offline {
            color: #a0a0a0;
        }
        .user-chat-header-status.typing {
            color: #00bfff;
            font-style: italic;
        }


        .user-chat-close {
            color: #e0e0e0;
            font-size: 28px;
            cursor: pointer;
            padding: 5px;
            transition: color 0.2s ease;
        }

        .user-chat-close:hover {
            color: #ff3366;
        }

        .user-chat-messages {
            flex-grow: 1;
            overflow-y: auto;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 0px;
            display: flex;
            flex-direction: column-reverse;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.2);
        }

        .user-chat-messages .chat-message .user-name {
            display: none;
        }


        .user-chat-input-container {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 15px;
            background-color: #1a2a3a;
            border-top: 1px solid #3d5a71;
            position: relative;
        }

        .chat-input-container input[type="text"]::placeholder {
            color: #a0a0a0;
        }

        .chat-input-container .send-icon {
            position: absolute;
            right: 25px;
            color: #00bfff;
            font-size: 18px;
            cursor: pointer;
            transition: color 0.2s ease;
        }

        .chat-input-container .send-icon:hover {
            color: #0099cc;
        }


        .chat-tabs {
            display: flex;
        }

        .chat-tab {
            padding: 10px 15px;
            cursor: pointer;
            font-weight: bold;
            color: #a0a0a0;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }

        .chat-tab:hover {
            color: #e0e0e0;
            background-color: rgba(61, 90, 113, 0.2);
        }

        .chat-tab.active-chat-tab {
            color: #00bfff;
            border-bottom: 3px solid #00bfff;
        }

        .friend-list-container {
            flex-grow: 1;
            overflow-y: auto;
            border: 1.5px solid #3d5a71;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 15px;
            background-color: #0d1a26;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.2);
            display: none;
        }

        .friend-list-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 10px 15px;
            border-bottom: 1.5px solid #2c3e50;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .friend-list-item:hover {
            background-color: rgba(61, 90, 113, 0.3);
        }

        .friend-list-item:last-child {
            border-bottom: none;
        }

        .friend-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            overflow: visible;
            background-color: #3a4b5d;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            flex-shrink: 0;
            border: 2px solid transparent;
        }

        .friend-avatar img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }

        .friend-avatar .fa-user-circle {
            font-size: 28px;
            color: #e0e0e0;
        }

        .friend-info {
            flex-grow: 1;
            text-align: left;
            min-width: 0;
        }

        .friend-name {
            font-weight: bold;
            color: #e0e0e0;
            font-size: 1.1em;
        }

        .friend-last-message {
            font-size: 0.9em;
            color: #a0a0a0;
            white-space: normal;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            word-break: break-all;
        }

        .friend-status-text {
            font-size: 0.8em;
            color: #00bfff;
        }

        .friend-status-text.active-now {
            color: #28a745;
        }

        .friend-status-text.active-ago {
            color: #f0ad4e;
        }

        .friend-status-text.offline {
            color: #a0a0a0;
        }

        .friend-avatar .online-indicator {
            bottom: -2px;
            right: -2px;
            width: 14px;
            height: 14px;
            border: 2px solid #0d1a26;
            box-sizing: border-box;
        }

        .custom-alert-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9998;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .custom-alert-overlay.visible {
            opacity: 1;
            pointer-events: auto;
        }

        .custom-alert-box {
            background-color: #1a2a3a;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.6);
            text-align: center;
            max-width: 400px;
            width: 90%;
            border: 1px solid #3d5a71;
            position: relative;
            transform: translateY(-20px);
            transition: transform 0.3s ease;
        }

        .custom-alert-overlay.visible .custom-alert-box {
            transform: translateY(0);
        }

        .custom-alert-box h2 {
            color: #00bfff;
            margin-bottom: 20px;
            font-size: 24px;
            font-weight: bold;
        }

        .custom-alert-box p {
            color: #e0e0e0;
            font-size: 16px;
            margin-bottom: 30px;
            line-height: 1.5;
        }

        .custom-alert-box button {
            background-color: #00bfff;
            color: #0d1a26;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            font-size: 16px;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        .custom-alert-box button:hover {
            background-color: #0099cc;
            transform: translateY(-2px);
        }

        /* Full-screen Embed Styles */
        .fullscreen-embed-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #0d1a26; /* Dark background */
            z-index: 2500; /* Higher than other overlays */
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }

        .fullscreen-embed-header {
            width: 100%;
            display: flex;
            justify-content: flex-end; /* Align close button to right */
            padding: 10px 15px;
            box-sizing: border-box;
            background-color: #1a2a3a;
            flex-shrink: 0; /* Don't shrink header */
        }

        .fullscreen-embed-close {
            color: #e0e0e0;
            font-size: 30px;
            cursor: pointer;
            padding: 5px;
            transition: color 0.2s ease;
        }

        .fullscreen-embed-close:hover {
            color: #ff3366;
        }

        .fullscreen-embed-iframe {
            width: 100%;
            height: 100%; /* Take up remaining height */
            border: none;
        }
    </style>
</head>
<body>

<div class="loading-overlay" id="loadingOverlay">
    <div class="spinner"></div>
    Loading...
</div>

<!-- Internet Status Overlay -->
<div class="internet-status-overlay" id="internetStatusOverlay">
    <i class="fas fa-wifi-slash icon"></i>
    <span class="message">No internet connection</span>
</div>

<div class="custom-alert-overlay" id="customAlertOverlay">
    <div class="custom-alert-box">
        <h2 id="customAlertTitle">Notification</h2>
        <p id="customAlertMessage"></p>
        <button id="customAlertCloseBtn">OK</button>
    </div>
</div>

<div class="domain-error-overlay" id="domainErrorOverlay">
    <h1>Access Denied!</h1>
    <p>This application is not authorized to run. Please contact support if you believe this is an error.</p>
</div>

<div class="main-app-container" id="mainAppContainer">

    <div class="app-header">
        <div class="logo">
            <img alt="Header Logo" id="headerLogo" src="" style="visibility: hidden;"/> <span id="premiumStatusHeader">PREMIUM</span>
        </div>
        <div class="header-icons">
            <div class="event-icon" id="eventIcon">
                <i class="fas fa-calendar-alt"></i>
            </div>
            <div class="category-icon" id="categoryIcon">
                <i class="fas fa-list"></i>
            </div>
            <div class="bookmark-icon" id="bookmarkIcon">
                <i class="fas fa-bookmark"></i>
            </div>
            <div class="search-icon" id="searchIcon">
                <i class="fas fa-search"></i>
            </div>
            <div class="add-link-icon" id="addLinkIcon">
                <i class="fas fa-plus"></i>
            </div>
        </div>
    </div>

    <div class="video-section">
        <video id="videoPlayer" controls></video>
        <iframe id="embedPlayer" allowfullscreen frameborder="0"></iframe>
        <div class="intro-video-overlay" id="introVideoOverlay">
            <video id="introVideoPlayer" src="" preload="auto" playsinline></video>
            <button class="skip-button" id="skipIntroButton">Skip Ad (5)</button>
            <div id="introAdButtonContainer" style="position: absolute; display: none;"></div>
        </div>
    </div>

    <div class="video-details">
        <div class="video-details-top-row">
            <div class="main-title" id="videoTitle">Loading...</div>
            <i class="fas fa-bookmark title-bookmark-icon" id="titleBookmarkIcon"></i>
        </div>
        <div class="views-info">
            <span id="viewCount">0</span> Views
            <span id="onlineCountSmall" style="margin-left: 15px; font-size: 0.9em; color: #00bfff;">
                <i class="fas fa-circle" style="font-size: 0.8em; vertical-align: middle;"></i> <span id="onlineCount">0</span> Online
            </span>
        </div>
    </div>

    <div class="actions-section">
        <div class="action-group">
            <div class="action-button like-btn has-border" id="likeBtn">
                <i class="fas fa-thumbs-up"></i> <span id="likeCount">0</span>
            </div>
            <div class="action-button dislike-btn" id="dislikeBtn">
                <i class="fas fa-thumbs-down"></i> <span id="dislikeCount">0</span>
            </div>
        </div>
        <div class="action-button share-btn" id="shareBtn">
            <span id="shareCount">0</span> <i class="fas fa-share-alt"></i> <span>Share</span>
        </div>
        <div class="action-button profile-btn" id="profileOpenBtn">
            <i class="fas fa-user"></i> <span>Profile</span>
        </div>
        <div class="action-button chat-btn" id="chatOpenBtn">
            <i class="fas fa-comment"></i> <span>Chat</span>
        </div>
    </div>

    <div class="channel-list-titles" id="channelListTitles">
        <h3 class="active-title" data-source-type="default" data-source-key="default" data-lang-key="all_channels_title">All Channels</h3>
    </div>

    <div class="all-channels-section" id="allChannelsSection">
        <h3 class="section-header">All Channels</h3>
        <ul class="all-channel-grid" id="allChannelGrid">
        </ul>
    </div>

</div>

<div class="username-overlay" id="usernameOverlay">
    <div class="username-input-box">
        <h2 data-lang-key="username_prompt">Enter your name to join chat</h2>
        <input type="text" id="usernameInput" placeholder="Your name..." data-lang-key="username_placeholder">
        <button id="joinChatBtn" data-lang-key="join_chat_button">Join</button>
    </div>
</div>

<div class="add-link-overlay" id="addLinkOverlay">
    <div class="add-link-box-container">
        <i class="fas fa-times add-link-close-btn" id="closeAddLinkBtn"></i>
        <h2 data-lang-key="add_link_heading">Add Link</h2>
        <input type="text" id="linkInput" placeholder="M3U or M3U8 Link..." data-lang-key="link_input_placeholder">
        <input type="text" id="customListNameInput" placeholder="List Name (required for M3U)" data-lang-key="list_name_placeholder">
        <button id="addLinkBtn" data-lang-key="add_button">Add</button>
    </div>
</div>


<div class="category-menu-overlay" id="categoryMenuOverlay">
    <div class="category-menu-header">
        <span data-lang-key="categories_heading">Categories</span>
        <i class="fas fa-times category-menu-close" id="closeCategoryMenuBtn"></i>
    </div>
    <ul class="category-list" id="categoryList">
    </ul>
</div>

<div class="search-overlay" id="searchOverlay">
    <div class="search-box-container">
        <i class="fas fa-times search-close-btn" id="closeSearchBtn"></i>
        <h2 data-lang-key="search_heading">Search Channel</h2>
        <div class="search-input-wrapper">
            <input type="text" id="searchInput" placeholder="Enter channel name..." data-lang-key="search_input_placeholder">
            <button id="clearSearchBtn">Clear</button>
        </div>
        <ul class="search-results-list" id="searchResultsList">
        </ul>
    </div>
</div>

<div class="bookmark-overlay" id="bookmarkOverlay">
    <div class="bookmark-list-container">
        <i class="fas fa-times bookmark-close-btn" id="closeBookmarkBtn"></i>
        <h2 data-lang-key="bookmarks_heading">Bookmarked Channels</h2>
        <ul class="bookmark-channels-list" id="bookmarkChannelsList">
        </ul>
    </div>
</div>

<div class="chat-fullscreen-overlay" id="chatFullscreenOverlay">
    <div class="chat-fullscreen-header">
        <div class="chat-header-tabs">
            <span id="liveChatTab" class="chat-tab active-chat-tab" data-lang-key="live_chat_heading">Live Chat</span>
            <span id="friendListTab" class="chat-tab" data-lang-key="friend_list_heading">Friend List</span>
        </div>
        <i class="fas fa-times chat-fullscreen-close" id="closeFullscreenChatBtn"></i>
    </div>
    <div class="chat-messages" id="fullscreenChatMessages">
    </div>
    <div class="friend-list-container" id="friendListContainer">
    </div>
    <div class="chat-input-container" id="publicChatInputContainer">
        <input type="text" id="fullscreenChatInput" placeholder="Type your message..." data-lang-key="chat_input_placeholder">
        <i class="fas fa-paper-plane send-icon" id="sendFullscreenChatIcon"></i>
    </div>
</div>

<div class="event-fullscreen-overlay" id="eventFullscreenOverlay">
    <div class="event-fullscreen-header">
        <span>Live Events</span>
        <i class="fas fa-times event-fullscreen-close" id="closeEventFullscreenBtn"></i>
    </div>
    <div class="event-grid" id="eventGrid">
        <div class="no-event-message">Loading event data...</div>
    </div>
</div>

<div class="profile-overlay" id="profileOverlay">
    <div class="profile-box-container">
        <i class="fas fa-times profile-close-btn" id="closeProfileBtn"></i>

        <div id="loginContainer">
            <h2>Login to your Account</h2>
            <input type="email" id="loginEmail" placeholder="Email" required>
            <input type="password" id="loginPassword" placeholder="Password" required>
            <button id="loginBtn">Login</button>
            <p>Don't have an account? <span id="showRegisterBtn" style="color:#00bfff; cursor:pointer;">Register here</span></p>
        </div>

        <div id="registerContainer" style="display: none;">
            <h2>Register a new Account</h2>
            <input type="text" id="registerName" placeholder="Your Name">
            <input type="email" id="registerEmail" placeholder="Email" required>
            <input type="password" id="registerPassword" placeholder="Password" required>
            <input type="text" id="registerPhone" placeholder="Phone Number (Optional)">
            <input type="text" id="registerPhotoURL" placeholder="Profile Image URL (Optional)">
            <button id="registerBtn">Register</button>
            <div class="progress-bar" id="registerProgressBar">
                <i class="fas fa-spinner fa-spin"></i> Registering...
            </div>
            <div class="success-message" id="registerSuccessMessage">
                <i class="fas fa-check-circle"></i> Registration Successful!
            </div>
            <p>Already have an account? <span id="showLoginBtn" style="color:#00bfff; cursor:pointer;">Login here</span></p>
        </div>

        <div id="userProfileContainer" style="display: none;">
            <h2>User Profile</h2>
            <div class="profile-image-container">
                <img alt="User Profile Image" id="profileImage" src="">
                <i id="defaultProfileIcon" class="fas fa-user-circle"></i>
            </div>
            <p><strong>Name:</strong> <span id="profileName"></span></p>
            <p><strong>Email:</strong> <span id="profileEmail"></span></p>
            <p><strong>Phone:</strong> <span id="profilePhone"></span></p>
            <p>
                <strong>Premium:</strong> <span id="profilePremiumStatus">N/A</span>
            </p>
            <p><strong>Balance:</strong> <span id="profileBalanceAmount">N/A</span></p>
            <p><strong>Status:</strong> <span id="profileBanStatus">N/A</span></p>
            <button id="logoutBtn">Logout</button>
        </div>
    </div>
</div>

<div class="user-chat-overlay" id="userChatOverlay">
    <div class="user-chat-header">
        <div style="display: flex; align-items: center;">
            <i class="fas fa-arrow-left user-chat-back-arrow" id="userChatBackArrow"></i>
            <div class="user-chat-header-avatar-container">
                <img alt="User Avatar" id="userChatTargetAvatar" src="" style="display: none;">
                <i id="userChatTargetDefaultIcon" class="fas fa-user-circle"></i>
                <div class="online-indicator" id="userChatTargetOnlineIndicator"></div>
            </div>
            <div class="user-chat-header-info">
                <span id="userChatTargetName" class="user-chat-header-name"></span>
                <span id="userChatTargetStatus" class="user-chat-header-status"></span>
            </div>
        </div>
        <i class="fas fa-times user-chat-close" id="closeUserChatBtn"></i>
    </div>
    <div class="user-chat-messages" id="userChatMessages">
    </div>
    <div class="chat-input-container" id="userChatInputContainer">
        <input type="text" id="userChatInput" placeholder="Type your message..." data-lang-key="chat_input_placeholder">
        <i class="fas fa-paper-plane send-icon" id="sendUserChatIcon"></i>
    </div>
</div>

<div class="fullscreen-embed-overlay" id="fullScreenEmbedOverlay">
    <div class="fullscreen-embed-header">
        <i class="fas fa-times fullscreen-embed-close" id="closeFullScreenEmbedBtn"></i>
    </div>
    <iframe class="fullscreen-embed-iframe" id="fullScreenEmbedIframe" allowfullscreen frameborder="0"></iframe>
</div>

<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyC6xiG5b0yMWkLl4ZN0G4hzpJmoyW_Tp6I",
        authDomain: "msm-4-39637.firebaseapp.com",
        projectId: "msm-4-39637",
        storageBucket: "msm-4-39637.appspot.com",
        messagingSenderId: "933945465803",
        appId: "1:933945465803:web:f3c4ce2cc93f901b23f44e",
        databaseURL: "https://msm-4-39637-default-rtdb.firebaseio.com"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth();
</script>

<script>
    const APP_ACCESS_KEY = "mySuperSecretAppKey123!@#";
    const GITHUB_CONFIG_URL = 'https://raw.githubusercontent.com/msplayerapp/MsM-BD/refs/heads/main/MsM_TV.json';

    const translations = {
        'en': {
            'all_channels_title': 'All Channels',
            'bangladesh_afghanistan': 'Bangladesh vs Afghanistan: Live Cricket',
            'views_label': 'Views',
            'share_button': 'Share',
            'chat_button': 'Chat',
            'username_prompt': 'Enter your name to join chat',
            'username_placeholder': 'Your name...',
            'join_chat_button': 'Join',
            'add_link_heading': 'Add Link',
            'link_input_placeholder': 'M3U or M3U8 Link...',
            'list_name_placeholder': 'List Name (required for M3U)',
            'add_button': 'Add',
            'categories_heading': 'Categories',
            'search_heading': 'Search Channel',
            'search_input_placeholder': 'Enter channel name...',
            'clear_button': 'Clear',
            'bookmarks_heading': 'Bookmarked Channels',
            'live_chat_heading': 'Live Chat',
            'chat_input_placeholder': 'Type your message...',
            'send_button': 'Send',
            'link_copied_alert': 'Link copied to clipboard: ',
            'link_copy_failed_alert': 'Failed to copy link. Please copy manually: ',
            'please_enter_name': 'Please enter a name.',
            'enter_list_name': 'Please provide a list name for M3U links.',
            'unsupported_link_type': 'Only M3U or M3U8 links are supported.',
            'failed_to_load_m3u': 'Failed to load M3U: ',
            'list_added_success': 'List added successfully!',
            'no_channels_found': 'No channels found.',
            'no_results_found': 'No results found.',
            'confirm_remove_list_prefix': 'Are you sure you want to remove the list "',
            'confirm_remove_list_suffix': '"?',
            'list_removed_success': 'List removed successfully.',
            'failed_to_remove_list': 'Failed to remove custom M3U list: ',
            'no_categories_found': 'No categories found.',
            'default_channels_load_failed': 'Failed to load built-in channels.',
            'categories_load_failed': 'Failed to load categories.',
            'custom_m3u_load_failed': 'Failed to load custom M3U lists from Firebase: ',
            'no_bookmarks_found': 'No bookmarked channels.',
            'bookmark_removed_success': 'Bookmark removed successfully.',
            'failed_to_remove_bookmark': 'Error removing bookmark:',
            'fallback_to_local_storage': 'Falling back to Local Storage for custom M3U lists.',
            'no_prev_data': 'No previous data found.',
            'failed_to_load_fallback': 'Failed to load. No previous data found.',
            'autoplay_failed': 'Autoplay failed:',
            'video_error': 'Native HLS video error.',
            'browser_unsupported': 'Your browser does not support this video stream.',
            'other_channels_none': 'No other channels available at the moment.',
            'channel_not_found_bookmark': 'Current channel not found in all channels for bookmarking.',
            'remove_bookmark_title': 'Remove Bookmark',
            'event_page_title': 'Live Events',
            'watch_match_button': 'Watch Match',
            'no_events_found': 'No upcoming events found.',
            'loading_event_data': 'Loading event data...',
            'banned_access_denied': 'You are banned from accessing channels. Please contact support.',
            'premium_required_alert': 'This is a VIP channel. Your premium access has expired or or is not active. Please log in with a premium account.',
            'login_premium_required': 'This is a VIP channel. Please log in to access premium content.',
            'premium_status_active': 'Active:',
            'premium_status_expired': 'Expired',
            'ban_status_active': 'You Banned for',
            'ban_2_status_expired': 'Ban Expired',
            'related_channels_title': 'Related',
            'friend_list_heading': 'Friend List',
            'no_friends_yet': 'No recent private chats. Start a chat from public chat.',
            'active_now': 'Active Now',
            'active_minutes_ago': 'Active {X}m ago',
            'active_hours_ago': 'Active {X}h ago',
            'active_days_ago': 'Active {X}d ago',
            'offline': 'Offline',
            'typing_status': '... typing',
            'get_premium_text': 'Get Premium', /* New translation key for text */
            'add_balance_text': 'Add +', /* New translation key for text */
            'no_internet_connection': 'No internet connection' /* New translation key for internet status */
        }
    };

    const likeCountEl = document.getElementById('likeCount');
    const dislikeCountEl = document.getElementById('dislikeCount');
    const viewCountEl = document.getElementById('viewCount');
    const onlineCountEl = document.getElementById('onlineCount');
    const shareCountEl = document.getElementById('shareCount');

    const likeBtn = document.getElementById('likeBtn');
    const dislikeBtn = document.getElementById('dislikeBtn');
    const shareBtn = document.getElementById('shareBtn');
    let userID = localStorage.getItem('uniqueUserID');
    if (!userID) {
        userID = 'user_' + Math.random().toString(36).substr(2, 9) + '_' + Date.now();
        localStorage.setItem('uniqueUserID', userID);
    }

    const chatRef = db.ref('messages');
    const userProfilesRef = db.ref('user_profiles');
    const allChannelsFirebaseRef = db.ref('All Channel');
    const yeashVideoRef = db.ref('yeash_video');
    const bogaKandeLogoRef = db.ref('Boga_kande');
    const dukaneJawRef = db.ref('dukane_jaw');
    const adsConfigRef = db.ref('ads_config');
    const hugaMaraRef = db.ref('Huga_mara');
    const yeashAdsRef = db.ref('yeash_ads'); // Firebase ref for intro ads

    const chatOpenBtn = document.getElementById('chatOpenBtn');
    const chatFullscreenOverlay = document.getElementById('chatFullscreenOverlay');
    const closeFullscreenChatBtn = document.getElementById('closeFullscreenChatBtn');
    const fullscreenChatMessagesEl = document.getElementById('fullscreenChatMessages');
    const fullscreenChatInput = document.getElementById('fullscreenChatInput');
    const sendFullscreenChatIcon = document.getElementById('sendFullscreenChatIcon');
    const activeChatUsersDisplay = document.getElementById('activeChatUsersDisplay');

    const liveChatTab = document.getElementById('liveChatTab');
    const friendListTab = document.getElementById('friendListTab');
    const friendListContainer = document.getElementById('friendListContainer');
    const publicChatInputContainer = document.getElementById('publicChatInputContainer');

    const usernameOverlay = document.getElementById('usernameOverlay');
    let currentUsername = '';
    let currentUserPhotoURL = '';
    let currentUserID = '';
    let isPremiumUser = false; // Flag for premium status

    const videoPlayer = document.getElementById('videoPlayer');
    const embedPlayer = document.getElementById('embedPlayer');
    const videoTitleEl = document.getElementById('videoTitle');
    const titleBookmarkIcon = document.getElementById('titleBookmarkIcon');
    const headerLogo = document.getElementById('headerLogo');
    const premiumStatusHeader = document.getElementById('premiumStatusHeader');

    const addLinkIcon = document.getElementById('addLinkIcon');
    const addLinkOverlay = document.getElementById('addLinkOverlay');
    const closeAddLinkBtn = document.getElementById('closeAddLinkBtn');
    const linkInput = document.getElementById('linkInput');
    const customListNameInput = document.getElementById('customListNameInput');
    const addLinkBtn = document.getElementById('addLinkBtn');

    const channelListTitles = document.getElementById('channelListTitles');
    const allChannelsSection = document.getElementById('allChannelsSection');
    const allChannelGrid = document.getElementById('allChannelGrid');

    let defaultChannels = [];
    let customM3ULists = {};
    let currentActiveChannelList = 'default';

    let allChannelsCombined = [];

    const categoryIcon = document.getElementById('categoryIcon');
    const categoryMenuOverlay = document.getElementById('categoryMenuOverlay');
    const closeCategoryMenuBtn = document.getElementById('closeCategoryMenuBtn');
    const categoryListEl = document.getElementById('categoryList');

    let allCategories = ['All'];
    let allGroupData = [];

    const searchIcon = document.getElementById('searchIcon');
    const searchOverlay = document.getElementById('searchOverlay');
    const closeSearchBtn = document.getElementById('closeSearchBtn');
    const searchInput = document.getElementById('searchInput');
    const clearSearchBtn = document.getElementById('clearSearchBtn');
    const searchResultsList = document.getElementById('searchResultsList');

    const bookmarkIcon = document.getElementById('bookmarkIcon');
    const bookmarkOverlay = document.getElementById('bookmarkOverlay');
    const closeBookmarkBtn = document.getElementById('closeBookmarkBtn');
    const bookmarkChannelsList = document.getElementById('bookmarkChannelsList');

    const eventIcon = document.getElementById('eventIcon');
    const eventFullscreenOverlay = document.getElementById('eventFullscreenOverlay');
    const closeEventFullscreenBtn = document.getElementById('closeEventFullscreenBtn');
    const eventGrid = document.getElementById('eventGrid');

    let countdownIntervals = {};
    let profileCountdownInterval = null;

    const userBookmarksRef = db.ref(`user_bookmarks/${userID}`);
    const customM3URef = db.ref(`custom_m3u_lists/${userID}`);
    const eventsRef = db.ref('Event');

    const securityConfigRef = db.ref('security_config');

    const mainAppContainer = document.getElementById('mainAppContainer');
    const domainErrorOverlay = document.getElementById('domainErrorOverlay');
    const loadingOverlay = document.getElementById('loadingOverlay');
    const internetStatusOverlay = document.getElementById('internetStatusOverlay'); // New element

    let defaultVideoSrc = '';
    let defaultVideoTitle = '';

    let currentVideoSrc = '';
    let currentVideoTitle = '';
    let currentChannelId = '';

    let currentChannelStatsRef = null;

    const userChannelInteractionsRef = db.ref(`user_channel_interactions/${userID}`);
    let currentUserLiked = false;
    let currentUserDisliked = false;

    const profileOpenBtn = document.getElementById('profileOpenBtn');
    const profileOverlay = document.getElementById('profileOverlay');
    const closeProfileBtn = document.getElementById('closeProfileBtn');
    const loginContainer = document.getElementById('loginContainer');
    const registerContainer = document.getElementById('registerContainer');
    const userProfileContainer = document.getElementById('userProfileContainer');

    const loginEmailInput = document.getElementById('loginEmail');
    const loginPasswordInput = document.getElementById('loginPassword');
    const loginBtn = document.getElementById('loginBtn');
    const showRegisterBtn = document.getElementById('showRegisterBtn');

    const registerNameInput = document.getElementById('registerName');
    const registerEmailInput = document.getElementById('registerEmail');
    const registerPasswordInput = document.getElementById('registerPassword');
    const registerPhoneInput = document.getElementById('registerPhone');
    const registerPhotoURLInput = document.getElementById('registerPhotoURL');
    const registerBtn = document.getElementById('registerBtn');
    const showLoginBtn = document.getElementById('showLoginBtn');
    const registerProgressBar = document.getElementById('registerProgressBar');
    const registerSuccessMessage = document.getElementById('registerSuccessMessage');

    const profileImage = document.getElementById('profileImage');
    const defaultProfileIcon = document.getElementById('defaultProfileIcon');
    const profileNameSpan = document.getElementById('profileName');
    const profileEmailSpan = document.getElementById('profileEmail');
    const profilePhoneSpan = document.getElementById('profilePhone');
    const profilePremiumStatusSpan = document.getElementById('profilePremiumStatus');
    const profileBalanceAmountSpan = document.getElementById('profileBalanceAmount'); // New element
    const profileBanStatusSpan = document.getElementById('profileBanStatus');
    const logoutBtn = document.getElementById('logoutBtn');

    const userChatOverlay = document.getElementById('userChatOverlay');
    const closeUserChatBtn = document.getElementById('closeUserChatBtn');
    const userChatBackArrow = document.getElementById('userChatBackArrow');
    const userChatTargetAvatar = document.getElementById('userChatTargetAvatar');
    const userChatTargetDefaultIcon = document.getElementById('userChatTargetDefaultIcon');
    const userChatTargetOnlineIndicator = document.getElementById('userChatTargetOnlineIndicator');
    const userChatTargetName = document.getElementById('userChatTargetName');
    const userChatTargetStatus = document.getElementById('userChatTargetStatus');
    const userChatMessagesEl = document.getElementById('userChatMessages');
    const userChatInput = document.getElementById('userChatInput');
    const sendUserChatIcon = document.getElementById('sendUserChatIcon');

    let currentPrivateChatUser = null;
    let onlineUsers = {};
    let privateChatHistory = {};
    let activeStatusUpdateInterval = null;

    const typingStatusRef = db.ref('typing_status');
    let typingTimeout = null;
    const TYPING_TIMEOUT_MS = 2000;

    const customAlertOverlay = document.getElementById('customAlertOverlay');
    const customAlertTitle = document.getElementById('customAlertTitle');
    const customAlertMessage = document.getElementById('customAlertMessage');
    const customAlertCloseBtn = document.getElementById('customAlertCloseBtn');

    // New Full-screen Embed elements
    const fullScreenEmbedOverlay = document.getElementById('fullScreenEmbedOverlay');
    const closeFullScreenEmbedBtn = document.getElementById('closeFullScreenEmbedBtn');
    const fullScreenEmbedIframe = document.getElementById('fullScreenEmbedIframe');

    // New elements for Intro Video
    const introVideoOverlay = document.getElementById('introVideoOverlay');
    const introVideoPlayer = document.getElementById('introVideoPlayer');
    const skipIntroButton = document.getElementById('skipIntroButton');
    const introAdButtonContainer = document.getElementById('introAdButtonContainer'); // Container for ad button

    let introVideoAdCountdownInterval; // For the "Skip Ad (X)" countdown
    let currentAdData = null; // Store the currently playing ad's data

    // Global variable to hold the listener for the current user's profile
    let currentUserProfileListener = null;


    window.alert = function(message) {
        customAlertTitle.textContent = 'Notification';
        customAlertMessage.textContent = message;
        customAlertOverlay.classList.add('visible');
    };

    customAlertCloseBtn.addEventListener('click', () => {
        customAlertOverlay.classList.remove('visible');
    });

    customAlertOverlay.addEventListener('click', (event) => {
        if (event.target === customAlertOverlay) {
            customAlertOverlay.classList.remove('visible');
        }
    });

    // Function to open the full-screen embed overlay
    function openFullScreenEmbed(url) {
        fullScreenEmbedIframe.src = url;
        fullScreenEmbedOverlay.style.display = 'flex';
        // Close other overlays if any are open
        closeAllOverlaysExcept(fullScreenEmbedOverlay);
    }

    // Event listener for the close button on the full-screen embed overlay
    closeFullScreenEmbedBtn.addEventListener('click', () => {
        fullScreenEmbedOverlay.style.display = 'none';
        fullScreenEmbedIframe.src = ''; // Clear the iframe source
    });


    function parseDateString(dateString) {
        if (!dateString) return null;
        let parts;
        // Check for YYYY-MM-DD format
        if (dateString.includes('-') && dateString.split('-')[0].length === 4) {
            parts = dateString.split('-');
            const year = parseInt(parts[0], 10);
            const month = parseInt(parts[1], 10) - 1; // Month is 0-indexed
            const day = parseInt(parts[2], 10);
            return new Date(year, month, day, 23, 59, 59, 999); // End of day
        } 
        // Check for DD-MM-YYYY format
        else if (dateString.includes('-') && dateString.split('-')[0].length === 2 && dateString.split('-')[2].length === 4) {
            parts = dateString.split('-');
            const day = parseInt(parts[0], 10);
            const month = parseInt(parts[1], 10) - 1; // Month is 0-indexed
            const year = parseInt(parts[2], 10);
            return new Date(year, month, day, 23, 59, 59, 999); // End of day
        }
        return null;
    }

    function setupChannelStats(channelId) {
        if (currentChannelStatsRef) {
            currentChannelStatsRef.off('value');
        }

        currentChannelStatsRef = db.ref(`channel_stats/${channelId}`);

        currentChannelStatsRef.child('views').transaction(current => {
            return (current || 0) + 1;
        }, (error) => {
            if (error) {
                console.error("Firebase transaction for channel views failed:", error);
            }
        });
        
        currentChannelStatsRef.on('value', snapshot => {
            const stats = snapshot.val() || { views: 0, likes: 0, dislikes: 0, shares: 0 };
            viewCountEl.textContent = stats.views || 0;
            likeCountEl.textContent = stats.likes || 0;
            dislikeCountEl.textContent = stats.dislikes || 0;
            shareCountEl.textContent = stats.shares || 0;
        });

        userChannelInteractionsRef.child(channelId).once('value', snapshot => {
            const interaction = snapshot.val();
            currentUserLiked = interaction ? interaction.liked : false;
            currentUserDisliked = interaction ? interaction.disliked : false;
        });
    }

    const presenceRef = db.ref('presence/' + userID);
    const connectedRef = db.ref('.info/connected');

    connectedRef.on('value', snapshot => {
        if (snapshot.val() === true) {
            const user = auth.currentUser;
            if (user) {
                const userPresenceRef = db.ref('presence/' + user.uid);
                userPresenceRef.onDisconnect().remove();
                userPresenceRef.set({
                    displayName: user.displayName || user.email.split('@')[0],
                    photoURL: user.photoURL || null,
                    last_active: firebase.database.ServerValue.TIMESTAMP
                });
                listenForPrivateMessagesForFriendList(user.uid);
            } else {
                presenceRef.onDisconnect().remove();
                presenceRef.set({
                    displayName: 'Guest_' + userID.substring(userID.length - 4),
                    last_active: firebase.database.ServerValue.TIMESTAMP
                });
            }
        }
    });

    const totalOnlineRef = db.ref('presence');
    totalOnlineRef.on('value', snapshot => {
        onlineUsers = snapshot.val() || {};
        const count = Object.keys(onlineUsers).length;
        onlineCountEl.textContent = count;
        if (userChatOverlay.style.display === 'flex' && currentPrivateChatUser) {
            updateUserChatHeaderOnlineStatus(currentPrivateChatUser);
        }
        if (friendListContainer.style.display === 'block') {
            displayFriendList();
        }
    });

    likeBtn.addEventListener('click', () => {
        if (!currentChannelId) return;

        currentChannelStatsRef.child('likes').transaction(current => {
            return (current || 0) + 1;
        });

        if (currentUserDisliked) {
            currentChannelStatsRef.child('dislikes').transaction(current => {
                return Math.max(0, (current || 0) - 1);
            });
            userChannelInteractionsRef.child(currentChannelId).update({ disliked: false });
            currentUserDisliked = false;
        }
        userChannelInteractionsRef.child(currentChannelId).update({ liked: true });
        currentUserLiked = true;
    });

    dislikeBtn.addEventListener('click', () => {
        if (!currentChannelId || currentUserDisliked) return;

        currentChannelStatsRef.child('dislikes').transaction(current => {
            return (current || 0) + 1;
        });

        if (currentUserLiked) {
            currentChannelStatsRef.child('likes').transaction(current => {
                return Math.max(0, (current || 0) - 1);
            });
            userChannelInteractionsRef.child(currentChannelId).update({ liked: false });
            currentUserLiked = false;
        }
        userChannelInteractionsRef.child(currentChannelId).update({ disliked: true });
        currentUserDisliked = true;
    });

    shareBtn.addEventListener('click', () => {
        if (!currentChannelId) {
            window.alert("No channel loaded to share.");
            return;
        }
        currentChannelStatsRef.child('shares').transaction(current => {
            return (current || 0) + 1;
        });

        const baseUrl = window.location.origin + window.location.pathname;
        const shareableLink = `${baseUrl}?channelId=${currentChannelId}`;

        navigator.clipboard.writeText(shareableLink).then(() => {
            window.alert(`Link copied to clipboard:\n${shareableLink}`);
        }).catch(err => {
            window.alert(`${translations.en.link_copy_failed_alert}\n${shareableLink}`);
        });
    });

    function showVideoPlayer() {
        videoPlayer.style.display = 'block';
        embedPlayer.style.display = 'none';
        embedPlayer.src = '';
    }

    function showIframePlayer(src) {
        videoPlayer.style.display = 'none';
        if (videoPlayer.hls) {
            videoPlayer.hls.destroy();
        }
        videoPlayer.pause();
        videoPlayer.src = '';
        
        embedPlayer.style.display = 'block';
        embedPlayer.src = src;
    }

    // `loadChannel` function now handles premium/ban checks and intro video logic
    async function loadChannel(src, title, id, isPremiumChannel = false, relatedCategory = null) {
        const user = auth.currentUser;
        const now = new Date().getTime();

        let userProfile = {};
        if (user) {
            try {
                const userProfileSnapshot = await userProfilesRef.child(user.uid).once('value');
                userProfile = userProfileSnapshot.val() || {};
            } catch (error) {
                console.error("Error fetching user profile for premium check:", error);
            }
        }
        
        const bannedUntilDate = parseDateString(userProfile.bannedUntil);
        const isBannedActive = userProfile.isBanned && bannedUntilDate && bannedUntilDate.getTime() > now;

        if (isBannedActive) {
            window.alert(translations.en.banned_access_denied); // Show alert, don't load fallback
            return; // Stop execution
        }

        if (isPremiumChannel) {
            if (!user) {
                window.alert(translations.en.login_premium_required); // Show alert, don't load fallback
                return; // Stop execution
            }

            const premiumUntilDate = parseDateString(userProfile.premiumUntil);
            const isPremiumActive = userProfile.isPremium && premiumUntilDate && premiumUntilDate.getTime() > now;

            if (!isPremiumActive) {
                window.alert(translations.en.premium_required_alert); // Show alert, don't load fallback
                return; // Stop execution
            }
        }

        // Stop current main video immediately before playing intro or new channel
        if (videoPlayer.hls) {
            videoPlayer.hls.destroy();
        }
        videoPlayer.pause();
        videoPlayer.src = '';
        embedPlayer.src = ''; // Clear embed player if it was active

        // Play intro video before loading the channel if user is NOT premium
        if (!isPremiumUser) { // Check isPremiumUser flag here
            await playRandomIntroAd(src, title, id, isPremiumChannel, relatedCategory);
        } else {
            // User is premium, load main channel directly
            loadMainChannelDirectly(src, title, id, isPremiumChannel, relatedCategory);
        }
    }

    // Function to play a random intro ad
    async function playRandomIntroAd(mainVideoSrc, mainVideoTitle, mainVideoId, isPremiumChannel, relatedCategory) {
        try {
            const adsSnapshot = await yeashAdsRef.once('value');
            const adsData = adsSnapshot.val();
            let activeAds = [];
            const now = new Date().getTime();

            if (adsData) {
                for (const adKey in adsData) {
                    if (adsData.hasOwnProperty(adKey)) {
                        const ad = adsData[adKey];
                        const validUntilDate = parseDateString(ad.validUntil);
                        // Check if ad is active and within its validity period
                        if (ad.videoUrl && ad.status === 'on' && (!validUntilDate || validUntilDate.getTime() > now)) {
                            activeAds.push({ ...ad, id: adKey });
                        }
                    }
                }
            }

            if (activeAds.length > 0) {
                currentAdData = activeAds[Math.floor(Math.random() * activeAds.length)]; // Select a random ad
                
                introVideoOverlay.style.display = 'flex';
                introVideoPlayer.src = currentAdData.videoUrl;
                
                // Reset skip button state
                let countdownSeconds = currentAdData.skippableAfterSeconds || 5; // Get skippable duration from ad data
                skipIntroButton.textContent = `Skip Ad (${countdownSeconds})`;
                skipIntroButton.disabled = true;
                skipIntroButton.style.display = 'block'; // Ensure it's visible
                
                // Clear previous intervals
                if (introVideoAdCountdownInterval) clearInterval(introVideoAdCountdownInterval);

                // Track ad view (increment 'views' count in Firebase)
                yeashAdsRef.child(currentAdData.id).child('views').transaction(current => (current || 0) + 1,
                    (error, committed, snapshot) => {
                        if (error) {
                            console.error("Firebase transaction for ad views failed:", error);
                        } else if (!committed) {
                            console.warn("Firebase transaction for ad views was aborted.");
                        } else {
                            // console.log("Ad view incremented successfully."); // For debugging
                        }
                    }
                );

                // Attempt to play intro video
                introVideoPlayer.play().then(() => {
                    // Autoplay succeeded, start countdown for skip button
                    introVideoAdCountdownInterval = setInterval(() => {
                        countdownSeconds--;
                        skipIntroButton.textContent = `Skip Ad (${countdownSeconds})`;
                        if (countdownSeconds <= 0) {
                            clearInterval(introVideoAdCountdownInterval);
                            skipIntroButton.textContent = `Skip Ad`;
                            skipIntroButton.disabled = false;
                        }
                    }, 1000);
                }).catch(error => {
                    console.warn("Intro video autoplay failed, user interaction needed:", error);
                    introVideoPlayer.pause();
                    introVideoPlayer.controls = true; // Show controls for manual play

                    // Start countdown to enable skip button even if not manually played
                    introVideoAdCountdownInterval = setInterval(() => {
                        countdownSeconds--;
                        skipIntroButton.textContent = `Play Ad (${countdownSeconds})`; // Indicate manual play needed
                        if (countdownSeconds <= 0) {
                            clearInterval(introVideoAdCountdownInterval);
                            skipIntroButton.textContent = `Skip Ad`;
                            skipIntroButton.disabled = false;
                        }
                    }, 1000);

                    // If user plays manually, ensure countdown starts and button changes
                    introVideoPlayer.onplay = () => {
                        if (introVideoAdCountdownInterval) { // Clear existing countdown if manually played early
                            clearInterval(introVideoAdCountdownInterval);
                        }
                        countdownSeconds = currentAdData.skippableAfterSeconds || 5; // Reset countdown on manual play
                        introVideoAdCountdownInterval = setInterval(() => {
                            countdownSeconds--;
                            skipIntroButton.textContent = `Skip Ad (${countdownSeconds})`;
                            if (countdownSeconds <= 0) {
                                clearInterval(introVideoAdCountdownInterval);
                                skipIntroButton.textContent = `Skip Ad`;
                                skipIntroButton.disabled = false;
                            }
                        }, 1000);
                    };
                });

                introVideoPlayer.onended = () => {
                    skipIntro(mainVideoSrc, mainVideoTitle, mainVideoId, isPremiumChannel, relatedCategory);
                };

                skipIntroButton.onclick = () => {
                    if (!skipIntroButton.disabled) {
                        skipIntro(mainVideoSrc, mainVideoTitle, mainVideoId, isPremiumChannel, relatedCategory);
                    }
                };

                // Render custom button if available
                renderAdButton(currentAdData);

            } else {
                // No active ads found, load main channel directly
                loadMainChannelDirectly(mainVideoSrc, mainVideoTitle, mainVideoId, isPremiumChannel, relatedCategory);
            }

        } catch (error) {
            console.error("Error fetching or playing intro ad:", error);
            // Fallback to main channel if ad loading fails
            loadMainChannelDirectly(mainVideoSrc, mainVideoTitle, mainVideoId, isPremiumChannel, relatedCategory);
        }
    }

    // Function to render the custom ad button
    function renderAdButton(adData) {
        const buttonContainer = document.getElementById('introAdButtonContainer');
        buttonContainer.innerHTML = ''; // Clear previous button

        if (adData.buttonText && adData.buttonLink && adData.buttonPosition) {
            const adButton = document.createElement('button');
            adButton.textContent = adData.buttonText;
            adButton.classList.add('ad-custom-button'); // Add a class for styling

            // Apply positioning based on adData.buttonPosition
            buttonContainer.style.display = 'block'; // Show container
            buttonContainer.style.position = 'absolute';
            buttonContainer.style.zIndex = '102'; // Above video and skip button

            // Reset all positioning styles first
            buttonContainer.style.top = '';
            buttonContainer.style.bottom = '';
            buttonContainer.style.left = '';
            buttonContainer.style.right = '';
            buttonContainer.style.transform = '';
            buttonContainer.style.display = 'flex'; // Use flex for centering within the container
            buttonContainer.style.justifyContent = 'center';
            buttonContainer.style.alignItems = 'center';


            switch (adData.buttonPosition) {
                case 'bottom-left':
                    buttonContainer.style.bottom = '20px';
                    buttonContainer.style.left = '20px';
                    buttonContainer.style.justifyContent = 'flex-start';
                    buttonContainer.style.alignItems = 'flex-end';
                    break;
                case 'bottom-right':
                    buttonContainer.style.bottom = '20px';
                    buttonContainer.style.right = '20px';
                    buttonContainer.style.justifyContent = 'flex-end';
                    buttonContainer.style.alignItems = 'flex-end';
                    break;
                case 'top-left':
                    buttonContainer.style.top = '20px';
                    buttonContainer.style.left = '20px';
                    buttonContainer.style.justifyContent = 'flex-start';
                    buttonContainer.style.alignItems = 'flex-start';
                    break;
                case 'top-right':
                    buttonContainer.style.top = '20px';
                    buttonContainer.style.right = '20px';
                    buttonContainer.style.justifyContent = 'flex-end';
                    buttonContainer.style.alignItems = 'flex-start';
                    break;
                case 'center':
                    buttonContainer.style.top = '50%';
                    buttonContainer.style.left = '50%';
                    buttonContainer.style.transform = 'translate(-50%, -50%)';
                    buttonContainer.style.justifyContent = 'center';
                    buttonContainer.style.alignItems = 'center';
                    break;
                default: // Default to bottom-center
                    buttonContainer.style.bottom = '20px';
                    buttonContainer.style.left = '50%';
                    buttonContainer.style.transform = 'translateX(-50%)';
                    buttonContainer.style.justifyContent = 'center';
                    buttonContainer.style.alignItems = 'flex-end';
                    break;
            }

            adButton.addEventListener('click', () => {
                // Track button click (increment 'clicks' count in Firebase)
                if (currentAdData && currentAdData.id) {
                    yeashAdsRef.child(currentAdData.id).child('clicks').transaction(current => (current || 0) + 1,
                        (error, committed, snapshot) => {
                            if (error) {
                                console.error("Firebase transaction for ad clicks failed:", error);
                            } else if (!committed) {
                                console.warn("Firebase transaction for ad clicks was aborted.");
                            } else {
                                // console.log("Ad click incremented successfully."); // For debugging
                            }
                        }
                    );
                }
                window.open(adData.buttonLink, '_blank');
            });
            buttonContainer.appendChild(adButton);
        } else {
            buttonContainer.style.display = 'none'; // Hide if no button data
        }
    }

    // Modified skipIntro to accept parameters for loading main channel
    function skipIntro(mainVideoSrc, mainVideoTitle, mainVideoId, isPremiumChannel, relatedCategory) {
        introVideoPlayer.pause();
        introVideoPlayer.currentTime = 0; // Reset video to start
        introVideoOverlay.style.display = 'none';
        introVideoPlayer.controls = false;
        if (introVideoAdCountdownInterval) {
            clearInterval(introVideoAdCountdownInterval);
            introVideoAdCountdownInterval = null;
        }
        document.getElementById('introAdButtonContainer').innerHTML = ''; // Clear ad button
        document.getElementById('introAdButtonContainer').style.display = 'none'; // Hide container
        loadMainChannelDirectly(mainVideoSrc, mainVideoTitle, mainVideoId, isPremiumChannel, relatedCategory);
    }


    // New helper function to load main channel directly without intro logic
    function loadMainChannelDirectly(src, title, id, isPremiumChannel, relatedCategory) {
        currentVideoSrc = src;
        currentVideoTitle = title;
        currentChannelId = id;
        videoTitleEl.textContent = title;

        setupChannelStats(currentChannelId);

        if (src.endsWith('.m3u8') || src.endsWith('.ts')) {
            showVideoPlayer();
            if (Hls.isSupported()) {
                if (videoPlayer.hls) {
                    videoPlayer.hls.destroy();
                }
                const hls = new Hls();
                hls.loadSource(src);
                hls.attachMedia(videoPlayer);
                videoPlayer.hls = hls;
                hls.on(Hls.Events.MANIFEST_PARSED, function () {
                    videoPlayer.play().catch(error => {
                        console.warn("Video autoplay failed (HLS), user interaction may be required:", error);
                    });
                });
                hls.on(Hls.Events.ERROR, function (event, data) {
                    console.error("HLS.js error:", data);
                    // Handle specific HLS errors if needed
                });
            } else if (videoPlayer.canPlayType('application/vnd.apple.mpegurl')) {
                videoPlayer.src = src;
                videoPlayer.addEventListener('loadedmetadata', function () {
                    videoPlayer.play().catch(error => {
                        console.warn("Video autoplay failed (Native HLS), user interaction may be required:", error);
                    });
                });
                videoPlayer.onerror = function() {
                    console.error("Native HLS video error.");
                };
            } else {
                console.error("Your browser does not support this video stream (HLS).");
            }
        } else {
            showIframePlayer(src);
        }
        closeAllOverlays();
        updateBookmarkButtonState(currentChannelId);

        if (relatedCategory) {
            displayRelatedChannels(relatedCategory);
        } else {
            switchChannelList('default');
            removeDynamicTabs();
            const defaultTab = document.querySelector('.channel-list-titles h3[data-source-type="default"]');
            if (defaultTab) {
                updateActiveChannelListTitle(defaultTab);
            }
        }
    }

    async function validateAccess() {
        try {
            const firebaseSnapshot = await securityConfigRef.once('value');
            const firebaseConfig = firebaseSnapshot.val() || {};

            const githubResponse = await fetch(GITHUB_CONFIG_URL);
            if (!githubResponse.ok) {
                throw new Error(`HTTP error! status: ${githubResponse.statusText}`);
            }
            const githubConfig = await githubResponse.json();

            const currentDomain = window.location.hostname;
            let domainAllowedFirebase = false;
            if (firebaseConfig.security === 'none') {
                domainAllowedFirebase = true;
            } else if (firebaseConfig.security === 'domains' && Array.isArray(firebaseConfig.allowed_domains)) {
                domainAllowedFirebase = firebaseConfig.allowed_domains.includes(currentDomain);
            }

            let domainAllowedGithub = false;
            if (githubConfig.security === 'none') {
                domainAllowedGithub = true;
            } else if (githubConfig.security === 'domains' && Array.isArray(githubConfig.allowed_domains)) {
                domainAllowedGithub = githubConfig.allowed_domains.includes(currentDomain);
            }

            const domainAllowed = domainAllowedFirebase && domainAllowedGithub;

            const firebaseAccessKey = firebaseConfig.app_access_key;
            const githubAccessKey = githubConfig.app_access_key;
            const scriptAccessKey = APP_ACCESS_KEY;

            const keyMatchFirebase = (firebaseAccessKey && firebaseAccessKey === scriptAccessKey);
            const keyMatchGithub = (githubAccessKey && githubAccessKey === scriptAccessKey);

            const keyMatch = keyMatchFirebase && keyMatchGithub;

            if (!domainAllowed) {
                return false;
            }
            if (!keyMatch) {
                return false;
            }
            if (!domainAllowed || !keyMatch) {
                return false;
            }

            return true;
        } catch (error) {
            console.error("Access validation failed:", error);
            return false;
        }
    }

    document.addEventListener('DOMContentLoaded', async function () {
        loadingOverlay.style.display = 'flex';
        const accessGranted = await validateAccess();
        if (!accessGranted) {
            mainAppContainer.style.display = 'none';
            domainErrorOverlay.style.display = 'flex';
            document.querySelector('#domainErrorOverlay h1').textContent = "Access Denied!";
            document.querySelector('#domainErrorOverlay p').textContent = "This application is not authorized to run. Please contact support if you believe this is an error.";
            loadingOverlay.style.display = 'none';
            return;
        }

        try {
            const logoDataPromise = bogaKandeLogoRef.once('value').then(snapshot => snapshot.val());
            const defaultVideoDataPromise = yeashVideoRef.once('value').then(snapshot => snapshot.val());
            const initialAllChannelsPromise = allChannelsFirebaseRef.once('value').then(snapshot => snapshot.val());
            const customM3UListsPromise = customM3URef.once('value').then(snapshot => {
                const firebaseCustomM3U = snapshot.val() || {};
                localStorage.setItem('customM3ULists', JSON.stringify(firebaseCustomM3U));
                return firebaseCustomM3U;
            });
            const adsConfigPromise = adsConfigRef.once('value').then(snapshot => snapshot.val());
            const bookmarksPromise = userBookmarksRef.once('value').then(snapshot => {
                const firebaseBookmarks = snapshot.val() || {};
                localStorage.setItem('userBookmarks', JSON.stringify(firebaseBookmarks));
                return firebaseBookmarks;
            });

            const [
                logoData,
                yeashVideoData,
                firebaseChannelsData,
                firebaseCustomM3U,
                adsConfig,
                firebaseBookmarks
            ] = await Promise.all([
                logoDataPromise,
                defaultVideoDataPromise,
                initialAllChannelsPromise,
                customM3UListsPromise,
                adsConfigPromise,
                bookmarksPromise
            ]);

            // Process logo data
            if (logoData && logoData.logo_url) {
                headerLogo.src = logoData.logo_url;
                headerLogo.style.visibility = 'visible';
                headerLogo.onerror = () => { headerLogo.style.visibility = 'hidden'; };
            } else {
                headerLogo.src = "https://blogger.googleusercontent.com/img/a/AVvXsEgbuJ1rxtHvaynErboODUyLM-aHw822buNfEteS1_iMlcGJfDzD9iSD-9578GpRN8VPxiYu86NQO34X51k-98fRHKP7l3DCekpH_5rDpfxSU0WxL4Efs7Zqp5zn4Enc-i3sF-ASji8y0sl_1MiNw_Q2SPAFHInAIzzOpBrzxjGRTO8uEKI-Fnxxmx1otao=s1200";
                headerLogo.style.visibility = 'visible';
                headerLogo.onerror = () => { headerLogo.style.visibility = 'hidden'; };
            }

            // Process default video data
            if (yeashVideoData) {
                if (yeashVideoData.Video && yeashVideoData.Title) {
                    defaultVideoSrc = yeashVideoData.Video;
                    defaultVideoTitle = yeashVideoData.Title;
                } else {
                    defaultVideoSrc = 'https://cloudfrontnet.vercel.app/tplay/playout/209611/master.m3u8';
                    defaultVideoTitle = 'Default Fallback Channel';
                }
            } else {
                defaultVideoSrc = 'https://cloudfrontnet.vercel.app/tplay/playout/209611/master.m3u8';
                defaultVideoTitle = 'Default Fallback Channel';
            }


            // Process all channels data (used to populate defaultChannels and allGroupData)
            let fetchedChannels = [];
            let fetchedCategories = new Set(['All']);
            allGroupData = [];
            if (firebaseChannelsData) {
                for (const groupNameKey in firebaseChannelsData) {
                    if (firebaseChannelsData.hasOwnProperty(groupNameKey)) {
                        const group = firebaseChannelsData[groupNameKey];
                        const groupStatus = group.status || 'on';
                        if (groupStatus === 'off') { continue; }
                        const groupOrder = group.order ? parseInt(group.order, 10) : Infinity;
                        const groupIsPremium = group.premium === 'on';
                        const groupLogo = group.logo || '';
                        allGroupData.push({ name: groupNameKey, order: groupOrder, logo: groupLogo, originalData: group });

                        let channelsInGroup = [];
                        for (const channelId in group) {
                            if (group.hasOwnProperty(channelId) && typeof group[channelId] === 'object' && group[channelId] !== null && group[channelId].name) {
                                const channel = group[channelId];
                                const channelStatus = channel.status || groupStatus;
                                if (channelStatus === 'off') { continue; }
                                const channelIsPremium = (channel.premium === 'on') || groupIsPremium;
                                const channelOrder = channel.order ? parseInt(channel.order, 10) : Infinity;
                                channelsInGroup.push({
                                    id: channelId, name: channel.name, logo: channel.logo, url: channel.url,
                                    category: groupNameKey, isPremium: channelIsPremium, order: channelOrder
                                });
                            }
                        }
                        channelsInGroup.sort((a, b) => a.order - b.order);
                        fetchedChannels = fetchedChannels.concat(channelsInGroup);
                    }
                }
            }
            allGroupData.sort((a, b) => {
                if (a.order !== b.order) { return a.order - b.order; }
                return a.name.localeCompare(b.name);
            });
            fetchedCategories.add('All');
            allGroupData.forEach(g => fetchedCategories.add(g.name));
            defaultChannels = fetchedChannels;
            allCategories = Array.from(fetchedCategories).sort();
            updateAllChannelsCombined();
            displayChannelListTitles();

            customM3ULists = firebaseCustomM3U; // ensure customM3ULists is set

            loadAdsConditionally();

            updateBookmarkButtonState(currentChannelId);


            const defaultChannelId = 'default_channel_' + btoa(defaultVideoSrc).replace(/=/g, '').substring(0, 8);
            currentChannelId = defaultChannelId;

            const urlParams = new URLSearchParams(window.location.search);
            const channelIdFromUrl = urlParams.get('channelId');

            // Initial load: load default video and all channels
            if (channelIdFromUrl) {
                const channelToLoad = allChannelsCombined.find(c => c.id === channelIdFromUrl);
                if (channelToLoad && (channelToLoad.status || 'on') === 'on') {
                    // Use loadMainChannelDirectly for initial load from URL
                    loadMainChannelDirectly(channelToLoad.url, channelToLoad.name, channelToLoad.id, channelToLoad.isPremium, channelToLoad.category);
                    window._channelLoadedFromUrl = true;
                } else {
                    window.alert(`Channel with ID "${channelIdFromUrl}" not found or is offline. Loading default channel.`);
                    // Use loadMainChannelDirectly for initial fallback
                    loadMainChannelDirectly(defaultVideoSrc, defaultVideoTitle, currentChannelId, false, null);
                }
            } else {
                // Use loadMainChannelDirectly for initial default load
                loadMainChannelDirectly(defaultVideoSrc, defaultVideoTitle, currentChannelId, false, null);
            }

        } catch (error) {
            console.error("Initialization failed:", error);
            domainErrorOverlay.style.display = 'flex';
            document.querySelector('#domainErrorOverlay h1').textContent = "Initialization Failed!";
            document.querySelector('#domainErrorOverlay p').textContent = "Failed to load essential data. Please check your internet connection or try again later.";
        } finally {
            loadingOverlay.style.display = 'none';
        }
    });

    // Function to update all instances of the current user's avatar in the UI
    function updateAllUserAvatarsInUI() {
        const user = auth.currentUser;
        if (!user) {
            // No logged-in user, no avatars to update for current user
            return;
        }

        // Update profile image in profile overlay (already handled by displayUserProfile, but good to have a fallback)
        if (currentUserPhotoURL) {
            profileImage.src = currentUserPhotoURL;
            profileImage.style.display = 'block';
            defaultProfileIcon.style.display = 'none';
        } else {
            profileImage.style.display = 'none';
            defaultProfileIcon.style.display = 'block';
        }

        // Update avatars in public chat messages
        const publicMessages = fullscreenChatMessagesEl.querySelectorAll('.chat-message');
        publicMessages.forEach(msgEl => {
            const senderId = msgEl.querySelector('.chat-avatar').dataset.uid;
            if (senderId === user.uid) {
                const avatarContainer = msgEl.querySelector('.chat-avatar');
                let avatarImg = avatarContainer.querySelector('img');
                let defaultIcon = avatarContainer.querySelector('.fa-user-circle');

                if (currentUserPhotoURL) {
                    if (!avatarImg) {
                        avatarImg = document.createElement('img');
                        avatarContainer.appendChild(avatarImg);
                    }
                    avatarImg.src = currentUserPhotoURL;
                    avatarImg.alt = currentUsername || 'User Avatar';
                    avatarImg.style.display = 'block';
                    if (defaultIcon) defaultIcon.style.display = 'none';
                } else {
                    if (avatarImg) avatarImg.style.display = 'none';
                    if (!defaultIcon) {
                        defaultIcon = document.createElement('i');
                        defaultIcon.classList.add('fas', 'fa-user-circle');
                        avatarContainer.appendChild(defaultIcon);
                    }
                    defaultIcon.style.display = 'block';
                }
                avatarContainer.dataset.photoUrl = currentUserPhotoURL || '';
                avatarContainer.dataset.displayName = currentUsername;
            }
        });

        // Update avatars in private chat messages (if private chat is open)
        if (userChatOverlay.style.display === 'flex' && currentPrivateChatUser) {
            const privateMessages = userChatMessagesEl.querySelectorAll('.chat-message');
            privateMessages.forEach(msgEl => {
                const senderId = msgEl.querySelector('.chat-avatar').dataset.uid;
                if (senderId === user.uid) {
                    const avatarContainer = msgEl.querySelector('.chat-avatar');
                    let avatarImg = avatarContainer.querySelector('img');
                    let defaultIcon = avatarContainer.querySelector('.fa-user-circle');

                    if (currentUserPhotoURL) {
                        if (!avatarImg) {
                            avatarImg = document.createElement('img');
                            avatarContainer.appendChild(avatarImg);
                        }
                        avatarImg.src = currentUserPhotoURL;
                        avatarImg.alt = currentUsername || 'User Avatar';
                        avatarImg.style.display = 'block';
                        if (defaultIcon) defaultIcon.style.display = 'none';
                    } else {
                        if (avatarImg) avatarImg.style.display = 'none';
                        if (!defaultIcon) {
                            defaultIcon = document.createElement('i');
                            defaultIcon.classList.add('fas', 'fa-user-circle');
                            avatarContainer.appendChild(defaultIcon);
                        }
                        defaultIcon.style.display = 'block';
                    }
                    avatarContainer.dataset.photoUrl = currentUserPhotoURL || '';
                    avatarContainer.dataset.displayName = currentUsername;
                }
            });
        }

        // Re-render friend list to update avatars and last messages
        if (friendListContainer.style.display === 'block') {
            displayFriendList();
        }
    }


    // Helper function to append messages to the chat display
    function appendMessageToChat(message, myUid, chatElement) {
        const messageElement = document.createElement('div');
        messageElement.id = `msg-${message.messageKey || Date.now()}`; // Use messageKey if available, otherwise fallback
        messageElement.classList.add('chat-message');

        const isMyMessage = message.senderId === myUid;

        if (isMyMessage) {
            messageElement.classList.add('my-message');
        } else {
            messageElement.classList.add('other-message');
        }

        // Use the global currentUserPhotoURL for *my* messages, otherwise use the message's senderPhoto
        const avatarToDisplay = isMyMessage ? currentUserPhotoURL : message.senderPhoto || '';
        const nameToDisplay = isMyMessage ? currentUsername : message.senderName || message.user;


        let statusHtml = '';
        if (isMyMessage) {
            if (message.seen) {
                statusHtml = '<span class="message-status">Seen <i class="fas fa-check-double" style="color: #28a745;"></i></span>';
            } else if (message.delivered) {
                statusHtml = '<span class="message-status">Delivered <i class="fas fa-check"></i></span>';
            } else {
                statusHtml = '<span class="message-status">Sent <i class="fas fa-check"></i></span>';
            }
        }

        messageElement.innerHTML = `
            <div class="chat-avatar" data-uid="${message.senderId}" data-display-name="${nameToDisplay}" data-photo-url="${avatarToDisplay}">
                ${avatarToDisplay ? `<img src="${avatarToDisplay}" alt="${nameToDisplay}">` : `<i class="fas fa-user-circle"></i>`}
            </div>
            <div class="message-content">
                ${isMyMessage ? '' : `<span class="user-name">${nameToDisplay}</span>`}
                <span>${message.text}</span>
                <span class="timestamp">${formatTimestamp(message.timestamp)}</span>
                ${statusHtml}
            </div>
        `;
        chatElement.prepend(messageElement); // Add to the top for reverse-column display
        chatElement.scrollTop = chatElement.scrollHeight; // Scroll to bottom to show latest message

        // Add click listener for public chat avatars to initiate private chat
        const chatAvatar = messageElement.querySelector('.chat-avatar');
        if (chatAvatar) {
            const user = auth.currentUser;
            if (user && user.uid !== chatAvatar.dataset.uid) { // Ensure it's not the current user's own avatar
                chatAvatar.addEventListener('click', () => {
                    openUserChat(chatAvatar.dataset.uid, chatAvatar.dataset.displayName, chatAvatar.dataset.photoUrl);
                });
            }
        }
    }


    function sendMessage(inputEl, isPrivate = false, targetUserId = null) {
        const messageText = inputEl.value.trim();
        if (messageText === '') return;

        const user = auth.currentUser;
        if (!user) {
            window.alert("You must be logged in to send chat messages.");
            return;
        }
        let senderName = currentUsername; // Use the global currentUsername
        let senderPhoto = currentUserPhotoURL; // Use the global currentUserPhotoURL
        let senderUid = user.uid;

        if (isPrivate && targetUserId) {
            const roomId = getPrivateChatRoomId(senderUid, targetUserId);
            const roomRef = hugaMaraRef.child(roomId);
            const messagesRef = roomRef.child('messages');
            const newMessageRef = messagesRef.push();
            const messageKey = newMessageRef.key; // Get the unique key generated by push()

            const messageData = {
                senderId: senderUid,
                receiverId: targetUserId,
                senderName: senderName,
                senderPhoto: senderPhoto,
                text: messageText,
                timestamp: firebase.database.ServerValue.TIMESTAMP,
                delivered: false,
                seen: false,
                messageKey: messageKey // Store the key within the message data
            };

            newMessageRef.set(messageData)
                .then(() => {
                    roomRef.child('lastMessage').set(messageData);
                    roomRef.child(`participants/${senderUid}`).set({
                        displayName: senderName,
                        photoURL: senderPhoto,
                        lastMessageTimestamp: firebase.database.ServerValue.TIMESTAMP
                    });
                    userProfilesRef.child(targetUserId).once('value').then(participantSnapshot => {
                        const receiverProfile = participantSnapshot.val();
                        const receiverDisplayName = receiverProfile?.name || receiverProfile?.email?.split('@')[0] || 'Unknown User';
                        const receiverPhotoURL = receiverProfile?.photoURL || null;
                        roomRef.child(`participants/${targetUserId}`).set({
                            displayName: receiverDisplayName,
                            photoURL: receiverPhotoURL,
                            lastMessageTimestamp: firebase.database.ServerValue.TIMESTAMP
                        });
                    });

                    typingStatusRef.child(user.uid).child(targetUserId).remove();
                    if (typingTimeout) {
                        clearTimeout(typingTimeout);
                        typingTimeout = null;
                    }

                    privateChatHistory[targetUserId] = {
                        displayName: senderName,
                        photoURL: senderPhoto,
                        lastMessage: messageData,
                        uid: targetUserId
                    };
                    if (friendListContainer.style.display === 'block') {
                        displayFriendList();
                    }
                    // Add the sent message to the private chat display immediately
                    appendMessageToChat(messageData, senderUid, userChatMessagesEl);
                })
                .catch(error => {
                    console.error("Error sending private message:", error);
                });

        } else {
            const newMessageRef = chatRef.push();
            const messageKey = newMessageRef.key; // Get the unique key generated by push()
            const messageData = {
                senderId: senderUid,
                user: senderName,
                text: messageText,
                timestamp: firebase.database.ServerValue.TIMESTAMP,
                delivered: false,
                seen: false,
                messageKey: messageKey // Store the key within the message data
            };
            newMessageRef.set(messageData)
                .catch(error => {
                    console.error("Error sending public message:", error);
                });
            // Append the sent message to public chat immediately
            appendMessageToChat(messageData, senderUid, fullscreenChatMessagesEl);
        }
        inputEl.value = '';
    }

    sendFullscreenChatIcon.addEventListener('click', () => {
        sendMessage(fullscreenChatInput);
    });

    fullscreenChatInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            sendMessage(fullscreenChatInput);
        }
    });
    
    sendUserChatIcon.addEventListener('click', () => {
        sendMessage(userChatInput, true, currentPrivateChatUser);
    });


    userChatInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            sendMessage(userChatInput, true, currentPrivateChatUser);
        }
    });

    /* Typing Indicator Logic */
    userChatInput.addEventListener('input', () => {
        const user = auth.currentUser;
        if (!user || !currentPrivateChatUser) return;

        const myUid = user.uid;
        const targetUid = currentPrivateChatUser;

        typingStatusRef.child(myUid).child(targetUid).set(true)
            .catch(error => console.error("Error setting typing status:", error));

        if (typingTimeout) {
            clearTimeout(typingTimeout);
        }
        typingTimeout = setTimeout(() => {
            typingStatusRef.child(myUid).child(targetUid).remove()
                .catch(error => console.error("Error removing typing status:", error));
            typingTimeout = null;
        }, TYPING_TIMEOUT_MS);
    });

    function listenForTypingStatus(myUid, targetUid) {
        const otherTypingRef = db.ref(`typing_status/${targetUid}/${myUid}`);

        if (userChatTargetStatus._typingListener) {
            userChatTargetStatus._typingListener.off('value');
        }
        
        const listener = otherTypingRef.on('value', snapshot => {
            const isTyping = snapshot.val();
            if (userChatOverlay.style.display === 'flex' && currentPrivateChatUser === targetUid) {
                if (isTyping) {
                    userChatTargetStatus.textContent = translations.en.typing_status;
                    userChatTargetStatus.className = 'user-chat-header-status typing';
                } else {
                    updateUserChatHeaderOnlineStatus(targetUid);
                }
            }
        }, error => console.error("Error listening for typing status:", error));
        userChatTargetStatus._typingListener = otherTypingRef;
    }

    function clearTypingStatusListeners() {
        if (userChatTargetStatus._typingListener) {
            userChatTargetStatus._typingListener.off('value');
            userChatTargetStatus._typingListener = null;
        }
        const user = auth.currentUser;
        if (user && currentPrivateChatUser) {
            typingStatusRef.child(user.uid).child(currentPrivateChatUser).remove()
                .catch(error => console.error("Error clearing typing status:", error));
        }
        if (typingTimeout) {
            clearTimeout(typingTimeout);
            typingTimeout = null;
        }
        userChatTargetStatus.textContent = '';
        userChatTargetStatus.className = 'user-chat-header-status';
    }

    
    function loadChatMessages(reloading = false) {
        if (!reloading) {
            fullscreenChatMessagesEl.innerHTML = '';
            chatRef.off('child_added');
        }

        chatRef.limitToLast(50).on('child_added', snapshot => {
            const message = snapshot.val();
            const messageKey = snapshot.key;
            // Prevent adding messages already present if reloading
            if (reloading && document.getElementById(`msg-${messageKey}`)) {
                return;
            }
            message.messageKey = messageKey; // Add key to message object for consistent ID generation
            appendMessageToChat(message, auth.currentUser ? auth.currentUser.uid : null, fullscreenChatMessagesEl);

            if (auth.currentUser && message.senderId !== auth.currentUser.uid && !message.delivered) {
                db.ref(`messages/${messageKey}`).update({ delivered: true })
                    .catch(error => console.error("Error updating message delivered status:", error));
            }
            if (auth.currentUser && message.senderId !== auth.currentUser.uid && chatFullscreenOverlay.style.display === 'flex' && !message.seen) {
                db.ref(`messages/${messageKey}`).update({ seen: true })
                    .catch(error => console.error("Error updating message seen status:", error));
            }
        }, error => console.error("Error loading chat messages:", error));
    }


    function formatTimestamp(timestamp) {
        if (!timestamp) return '';
        const date = new Date(timestamp);
        let hours = date.getHours();
        const minutes = date.getMinutes();
        const ampm = hours >= 12 ? 'PM' : 'AM';
        hours = hours % 12;
        hours = hours ? hours : 12;
        const strMinutes = minutes < 10 ? '0'+minutes : minutes;
        const day = date.getDate();
        const month = date.getMonth() + 1;
        const year = date.getFullYear();
        return `${hours}:${strMinutes} ${ampm} - ${day}/${month}/${year}`;
    }

    function getActiveStatusText(lastActiveTimestamp) {
        if (!lastActiveTimestamp) return { text: translations.en.offline, class: 'offline' };

        const now = new Date().getTime();
        const diffMs = now - lastActiveTimestamp;
        const diffMinutes = Math.floor(diffMs / (1000 * 60));
        const diffHours = Math.floor((diffMs / (1000 * 60 * 60)));
        const diffDays = Math.floor((diffMs / (1000 * 60 * 60 * 24)));

        if (diffMinutes <= 5) {
            return { text: translations.en.active_now, class: 'active-now' };
        }
        if (diffMinutes < 60) {
            return { text: translations.en.active_minutes_ago.replace('{X}', diffMinutes), class: 'active-ago' };
        }
        if (diffHours < 24) {
            return { text: translations.en.active_hours_ago.replace('{X}', diffHours), class: 'active-ago' };
        }
        if (diffDays < 7) {
            return { text: translations.en.active_days_ago.replace('{X}', diffDays), class: 'active-ago' };
        }
        
        return { text: translations.en.offline, class: 'offline' };
    }


    chatOpenBtn.addEventListener('click', () => {
        const user = auth.currentUser;
        if (!user) {
            window.alert("You must be logged in to join the chat.");
            return;
        }
        closeAllOverlaysExcept(chatFullscreenOverlay);
        chatFullscreenOverlay.style.display = 'flex';
        fullscreenChatInput.focus();
        showChatTab('live');
    });

    closeFullscreenChatBtn.addEventListener('click', () => {
        chatFullscreenOverlay.style.display = 'none';
        chatRef.off('child_added');
        if (db._privateChatFriendListListener) {
            db._privateChatFriendListListener.off();
        }
        if (activeStatusUpdateInterval) {
            clearInterval(activeStatusUpdateInterval);
            activeStatusUpdateInterval = null;
        }
        clearTypingStatusListeners();
    });

    liveChatTab.addEventListener('click', () => showChatTab('live'));
    friendListTab.addEventListener('click', () => showChatTab('friends'));

    function showChatTab(tabName) {
        if (tabName === 'live') {
            liveChatTab.classList.add('active-chat-tab');
            friendListTab.classList.remove('active-chat-tab');
            fullscreenChatMessagesEl.style.display = 'flex';
            publicChatInputContainer.style.display = 'flex';
            friendListContainer.style.display = 'none';
            loadChatMessages();
            if (activeStatusUpdateInterval) {
                clearInterval(activeStatusUpdateInterval);
                activeStatusUpdateInterval = null;
            }
            clearTypingStatusListeners();

        } else if (tabName === 'friends') {
            friendListTab.classList.add('active-chat-tab');
            liveChatTab.classList.remove('active-chat-tab');
            fullscreenChatMessagesEl.style.display = 'none';
            publicChatInputContainer.style.display = 'none';
            friendListContainer.style.display = 'block';
            chatRef.off('child_added');
            if (auth.currentUser && !db._privateChatFriendListListener) {
                listenForPrivateMessagesForFriendList(auth.currentUser.uid);
            }
            displayFriendList();

            if (!activeStatusUpdateInterval) {
                activeStatusUpdateInterval = setInterval(displayFriendList, 60000);
            }
            clearTypingStatusListeners();
        }
    }

    function getPrivateChatRoomId(uid1, uid2) {
        return uid1 < uid2 ? `${uid1}_${uid2}` : `${uid2}_${uid1}`;
    }

    async function openUserChat(targetUid, targetDisplayName, targetPhotoUrl) {
        const user = auth.currentUser;
        if (!user || user.uid === targetUid) {
            return;
        }

        currentPrivateChatUser = targetUid;

        userChatTargetName.textContent = targetDisplayName;
        if (targetPhotoUrl) {
            userChatTargetAvatar.src = targetPhotoUrl;
            userChatTargetAvatar.style.display = 'block';
            userChatTargetDefaultIcon.style.display = 'none';
        } else {
            userChatTargetAvatar.style.display = 'none';
            userChatTargetDefaultIcon.style.display = 'block';
        }
        updateUserChatHeaderOnlineStatus(targetUid);
        listenForTypingStatus(user.uid, targetUid);

        closeAllOverlaysExcept(userChatOverlay);
        userChatOverlay.style.display = 'flex';
        userChatInput.focus();

        loadPrivateMessages(user.uid, targetUid);
    }

    function updateUserChatHeaderOnlineStatus(targetUid) {
        const lastActiveTimestamp = onlineUsers[targetUid]?.last_active || null;
        const status = getActiveStatusText(lastActiveTimestamp);

        if (status.class === 'active-now') {
            userChatTargetOnlineIndicator.style.display = 'block';
        } else {
            userChatTargetOnlineIndicator.style.display = 'none';
        }
        
        userChatTargetStatus.textContent = status.text;
        userChatTargetStatus.className = `user-chat-header-status ${status.class}`;
    }

    function loadPrivateMessages(myUid, targetUid) {
        userChatMessagesEl.innerHTML = '';
        const roomId = getPrivateChatRoomId(myUid, targetUid);
        const privateMessagesRef = hugaMaraRef.child(roomId).child('messages');

        if (userChatMessagesEl._firebaseListener) {
            userChatMessagesEl._firebaseListener.off('child_added');
        }

        const listener = privateMessagesRef.limitToLast(50).on('child_added', snapshot => {
            const message = snapshot.val();
            const messageKey = snapshot.key;
            message.messageKey = messageKey; // Add key to message object for consistent ID generation

            appendMessageToChat(message, myUid, userChatMessagesEl);

            if (message.senderId !== myUid && !message.delivered) {
                privateMessagesRef.child(messageKey).update({ delivered: true })
                    .catch(error => console.error("Error updating private message delivered status:", error));
            }
            if (message.senderId !== myUid && userChatOverlay.style.display === 'flex' && !message.seen) {
                privateMessagesRef.child(messageKey).update({ seen: true })
                    .catch(error => console.error("Error updating private message seen status:", error));
            }
        }, error => console.error("Error loading private messages:", error));
        userChatMessagesEl._firebaseListener = privateMessagesRef;
    }

    closeUserChatBtn.addEventListener('click', () => {
        userChatOverlay.style.display = 'none';
        currentPrivateChatUser = null;
        if (userChatMessagesEl._firebaseListener) {
            userChatMessagesEl._firebaseListener.off('child_added');
        }
        clearTypingStatusListeners();
        if (chatFullscreenOverlay.style.display === 'flex') {
            showChatTab('friends');
        }
    });

    userChatBackArrow.addEventListener('click', () => {
        closeUserChatBtn.click();
        chatFullscreenOverlay.style.display = 'flex';
    });


    addLinkIcon.addEventListener('click', () => {
        addLinkOverlay.style.display = 'flex';
        closeAllOverlaysExcept(addLinkOverlay);
        linkInput.focus();
    });

    closeAddLinkBtn.addEventListener('click', () => {
        addLinkOverlay.style.display = 'none';
        linkInput.value = '';
        customListNameInput.value = '';
    });

    addLinkBtn.addEventListener('click', async () => {
        const link = linkInput.value.trim();
        const customListName = customListNameInput.value.trim();

        if (!link) {
            window.alert("Please enter a link.");
            return;
        }

        addLinkOverlay.style.display = 'none';

        if (link.endsWith('.m3u8') || link.endsWith('.ts')) {
            loadChannel(link, "Custom Stream", 'custom_stream_' + Date.now(), false, null);
        } else if (link.endsWith('.m3u')) {
            if (!customListName) {
                window.alert("Please provide a list name for M3U links.");
                addLinkOverlay.style.display = 'flex';
                return;
            }
            try {
                const response = await fetch(link);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const text = await response.text();
                const { channels: newChannels } = parseM3U(text);

                const newM3UKey = customM3URef.push().key;
                const m3uData = {
                    name: customListName,
                    url: link,
                    channels: newChannels
                };
                await customM3URef.child(newM3UKey).set(m3uData);
                
                window.alert(`List '${customListName}' added successfully!`);
            } catch (error) {
                console.error("Failed to load M3U:", error);
                window.alert(`${translations.en.failed_to_load_m3u} ${error.message}`);
            }
        } else {
            loadChannel(link, "Custom Embed", 'custom_embed_' + Date.now(), false, null);
        }
        linkInput.value = '';
        customListNameInput.value = '';
    });

    function parseM3U(m3uContent) {
        const lines = m3uContent.split('\n');
        const channels = [];
        const categories = new Set();
        let currentChannel = {};

        for (const line of lines) {
            const trimmedLine = line.trim();
            if (trimmedLine.startsWith('#EXTINF:')) {
                const nameMatch = /#EXTINF:.*,(.*)/.exec(trimmedLine);
                if (nameMatch && nameMatch[1]) {
                    currentChannel.name = nameMatch[1].trim();
                }

                const logoMatch = /tvg-logo="([^"]+)"/.exec(trimmedLine);
                if (logoMatch && logoMatch[1]) {
                    currentChannel.logo = logoMatch[1].trim();
                } else {
                    currentChannel.logo = '';
                }

                const groupMatch = /group-title="([^"]+)"/.exec(trimmedLine);
                if (groupMatch && groupMatch[1]) {
                    currentChannel.category = groupMatch[1].trim();
                    categories.add(currentChannel.category);
                } else {
                    currentChannel.category = 'Uncategorized';
                    categories.add('Uncategorized');
                }

                const statusMatch = /status="([^"]+)"/.exec(trimmedLine);
                currentChannel.status = statusMatch ? statusMatch[1].trim() : 'on';

                const premiumMatch = /premium="([^"]+)"/.exec(trimmedLine);
                currentChannel.isPremium = premiumMatch ? (premiumMatch[1].trim() === 'on') : false;

                const orderMatch = /order="(\d+)"/.exec(trimmedLine);
                currentChannel.order = orderMatch ? parseInt(orderMatch[1], 10) : Infinity;

                const rawId = currentChannel.name || '';
                currentChannel.id = (rawId.replace(/[^a-zA-Z0-9]/g, '_').toLowerCase() || 'channel') + '_' + btoa(trimmedLine).substring(0, 8).replace(/=/g, '');

            } else if (trimmedLine && !trimmedLine.startsWith('#')) {
                currentChannel.url = trimmedLine;
                if (currentChannel.name && currentChannel.url && currentChannel.id) {
                    channels.push(currentChannel);
                }
                currentChannel = {};
            }
        }
        return { channels, categories: Array.from(categories).sort() };
    }

    async function fetchAllChannelsFromFirebase() {
        return new Promise((resolve, reject) => {
            allChannelsFirebaseRef.once('value')
                .then(snapshot => {
                    const firebaseChannelsData = snapshot.val();
                    let fetchedChannels = [];
                    let fetchedCategories = new Set(['All']);
                    allGroupData = [];

                    if (firebaseChannelsData) {
                        for (const groupNameKey in firebaseChannelsData) {
                            if (firebaseChannelsData.hasOwnProperty(groupNameKey)) {
                                const group = firebaseChannelsData[groupNameKey];
                                
                                const groupStatus = group.status || 'on';
                                if (groupStatus === 'off') {
                                    continue;
                                }

                                const groupOrder = group.order ? parseInt(group.order, 10) : Infinity;
                                const groupIsPremium = group.premium === 'on';
                                const groupLogo = group.logo || '';

                                allGroupData.push({ name: groupNameKey, order: groupOrder, logo: groupLogo, originalData: group });

                                let channelsInGroup = [];
                                for (const channelId in group) {
                                    if (group.hasOwnProperty(channelId) && typeof group[channelId] === 'object' && group[channelId] !== null && group[channelId].name) {
                                        const channel = group[channelId];
                                        
                                        const channelStatus = channel.status || groupStatus;
                                        if (channelStatus === 'off') {
                                            continue;
                                        }

                                        const channelIsPremium = (channel.premium === 'on') || groupIsPremium;
                                        const channelOrder = channel.order ? parseInt(channel.order, 10) : Infinity;

                                        channelsInGroup.push({
                                            id: channelId,
                                            name: channel.name,
                                            logo: channel.logo,
                                            url: channel.url,
                                            category: groupNameKey,
                                            isPremium: channelIsPremium,
                                            order: channelOrder
                                        });
                                    }
                                }
                                channelsInGroup.sort((a, b) => a.order - b.order);
                                fetchedChannels = fetchedChannels.concat(channelsInGroup);
                            }
                        }
                    }

                    allGroupData.sort((a, b) => {
                        if (a.order !== b.order) {
                            return a.order - b.order;
                        }
                        return a.name.localeCompare(b.name);
                    });

                    fetchedCategories.add('All');
                    allGroupData.forEach(g => fetchedCategories.add(g.name));

                    defaultChannels = fetchedChannels;
                    allCategories = Array.from(fetchedCategories).sort();
                    updateAllChannelsCombined();
                    displayChannelListTitles();
                    resolve();
                })
                .catch(error => {
                    console.error("Failed to fetch all channels from Firebase:", error);
                    window.alert(translations.en.default_channels_load_failed);
                    const allChannelsErrorItem = document.createElement('li');
                    allChannelsErrorItem.textContent = translations.en.default_channels_load_failed;
                    allChannelsErrorItem.style.color = '#a0a0a0';
                    allChannelsErrorItem.style.gridColumn = '1 / -1';
                    allChannelGrid.appendChild(allChannelsErrorItem);
                    const categoryErrorItem = document.createElement('li');
                    categoryErrorItem.style.color = '#a0a0a0';
                    categoryErrorItem.textContent = translations.en.categories_load_failed;
                    categoryListEl.appendChild(categoryErrorItem);
                    reject(error);
                });
        });
    }

    function updateAllChannelsCombined() {
        allChannelsCombined = [...defaultChannels];
        const newAllCategories = new Set(['All']);

        defaultChannels.forEach(channel => {
            if (channel.category) newAllCategories.add(channel.category);
        });

        for (const key in customM3ULists) {
            if (customM3ULists.hasOwnProperty(key)) {
                const customList = customM3ULists[key];
                customList.channels.forEach(channel => {
                    if (!channel.category && customList.name) {
                        channel.category = customList.name;
                    }
                    allChannelsCombined.push(channel);
                    if (channel.category) newAllCategories.add(channel.category);
                });
            }
        }
        allChannelsCombined.sort((a, b) => (a.order || Infinity) - (b.order || Infinity));
        allCategories = Array.from(newAllCategories).sort();
    }

    function displayAllChannels(channelsToDisplay) {
        allChannelGrid.innerHTML = '';

        if (channelsToDisplay.length === 0) {
            const noChannelsItem = document.createElement('li');
            noChannelsItem.textContent = translations.en.no_channels_found;
            noChannelsItem.style.color = '#a0a0a0';
            noChannelsItem.style.gridColumn = '1 / -1';
            allChannelGrid.appendChild(noChannelsItem);
            return;
        }

        channelsToDisplay.sort((a, b) => (a.order || Infinity) - (b.order || Infinity));

        channelsToDisplay.forEach(channel => {
            const isPremium = channel.isPremium;
            if ((channel.status || 'on') === 'off') {
                return;
            }

            const listItem = document.createElement('li');
            listItem.classList.add('all-channel-item');
            
            listItem.innerHTML = `
                <div class="channel-icon-small">
                    ${channel.logo ? `<img src="${channel.logo}" alt="${channel.name} Logo" style="width: 100%; height: 100%; border-radius: 50%;">` : channel.name.charAt(0).toUpperCase()}
                </div>
                <span class="channel-name-small">${channel.name} ${isPremium ? '&#11088;' : ''}</span>
            `;
            listItem.dataset.src = channel.url;
            listItem.dataset.title = channel.name;
            listItem.dataset.id = channel.id;
            listItem.dataset.isPremium = isPremium;
            listItem.dataset.status = channel.status;
            listItem.dataset.category = channel.category;

            listItem.addEventListener('click', (e) => {
                const src = e.currentTarget.dataset.src;
                const title = e.currentTarget.dataset.title;
                const id = e.currentTarget.dataset.id;
                const isPremiumChannel = e.currentTarget.dataset.isPremium === 'true';
                const category = e.currentTarget.dataset.category;
                loadChannel(src, title, id, isPremiumChannel, category); // This will now trigger intro video logic
            });
            allChannelGrid.appendChild(listItem);
        });
    }

    function displayChannelListTitles(mode = 'default', contextData = null) {
        channelListTitles.innerHTML = '';

        const defaultTitle = document.createElement('h3');
        defaultTitle.textContent = translations.en.all_channels_title;
        defaultTitle.dataset.sourceType = 'default';
        defaultTitle.dataset.sourceKey = 'default';
        defaultTitle.addEventListener('click', () => {
            switchChannelList('default');
            removeDynamicTabs();
        });
        channelListTitles.appendChild(defaultTitle);

        if (mode === 'category' && contextData) {
            const categoryTitle = document.createElement('h3');
            categoryTitle.textContent = contextData;
            categoryTitle.dataset.sourceType = 'category-filter';
            categoryTitle.dataset.sourceKey = contextData;
            categoryTitle.classList.add('dynamic-tab');
            categoryTitle.addEventListener('click', () => {
                const channelsToFilter = allChannelsCombined;
                const filteredChannels = channelsToFilter.filter(channel =>
                    channel.category === contextData && (channel.status || 'on') === 'on'
                );
                displayAllChannels(filteredChannels);
                updateActiveChannelListTitle(categoryTitle);
            });
            channelListTitles.appendChild(categoryTitle);
        } else if (mode === 'related' && contextData) {
            const relatedTitle = document.createElement('h3');
            relatedTitle.textContent = translations.en.related_channels_title;
            relatedTitle.dataset.sourceType = 'related-filter';
            relatedTitle.dataset.sourceKey = contextData;
            relatedTitle.classList.add('dynamic-tab');
            relatedTitle.addEventListener('click', () => {
                displayRelatedChannels(contextData);
                updateActiveChannelListTitle(relatedTitle);
            });
            channelListTitles.appendChild(relatedTitle);
        }

        const sortedCustomM3UKeys = Object.keys(customM3ULists).sort((a, b) => {
            const listA = customM3ULists[a];
            const listB = customM3ULists[b];
            const orderA = listA.order ? parseInt(listA.order, 10) : Infinity;
            const orderB = listB.order ? parseInt(listB.order, 10) : Infinity;

            if (orderA !== orderB) {
                return orderA - b.order;
            }
            return listA.name.localeCompare(listB.name);
        });

        sortedCustomM3UKeys.forEach(key => {
            const customList = customM3ULists[key];
            if (customList.status === 'off') {
                return;
            }

            const customTitle = document.createElement('h3');
            customTitle.textContent = customList.name;
            customTitle.dataset.sourceType = 'custom';
            customTitle.dataset.sourceKey = key;
            customTitle.addEventListener('click', () => {
                switchChannelList(key);
                removeDynamicTabs();
            });

            const removeBtn = document.createElement('button');
            removeBtn.classList.add('remove-custom-m3u-btn');
            removeBtn.innerHTML = '<i class="fas fa-times"></i>';
            removeBtn.title = `${translations.en.remove_bookmark_title} "${customList.name}"`;
            removeBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                removeCustomM3U(key, customList.name);
            });
            customTitle.appendChild(removeBtn);
            channelListTitles.appendChild(customTitle);
        });
        updateActiveChannelListTitle();
    }

    function removeDynamicTabs() {
        document.querySelectorAll('.channel-list-titles .dynamic-tab').forEach(tab => {
            tab.remove();
        });
    }

    function switchChannelList(sourceKey) {
        currentActiveChannelList = sourceKey;
        let channelsToShow = [];
        if (sourceKey === 'default') {
            channelsToShow = defaultChannels;
        } else {
            channelsToShow = customM3ULists[sourceKey]?.channels || [];
            channelsToShow = channelsToShow.filter(channel => (channel.status || 'on') === 'on');
        }
        displayAllChannels(channelsToShow);
        updateActiveChannelListTitle(document.querySelector('.channel-list-titles h3[data-source-type="default"]'));
    }

    function updateActiveChannelListTitle(activeTabElement = null) {
        document.querySelectorAll('.channel-list-titles h3').forEach(titleEl => {
            titleEl.classList.remove('active-title');
        });

        if (activeTabElement) {
            activeTabElement.classList.add('active-title');
        } else {
            const defaultTab = document.querySelector('.channel-list-titles h3[data-source-type="default"]');
            if (defaultTab) {
                defaultTab.classList.add('active-title');
            }
        }
    }

    function displayRelatedChannels(category) {
        removeDynamicTabs();

        const relatedChannels = allChannelsCombined.filter(channel =>
            channel.category === category && (channel.status || 'on') === 'on'
        );
        displayAllChannels(relatedChannels);
        
        displayChannelListTitles('related', category);
        const relatedTab = document.querySelector('.channel-list-titles h3[data-source-type="related-filter"]');
        if (relatedTab) {
            updateActiveChannelListTitle(relatedTab);
        }
    }

    async function removeCustomM3U(key, name) {
        if (window.confirm(`${translations.en.confirm_remove_list_prefix}"${name}"${translations.en.confirm_remove_list_suffix}`)) {
            try {
                await customM3URef.child(key).remove();
                window.alert(`${translations.en.list_removed_success}`);
            } catch (error) {
                console.error("Failed to remove custom M3U list:", error);
                window.alert(`${translations.en.failed_to_load_m3u} ${error.message}`);
            }
        }
    }

    categoryIcon.addEventListener('click', () => {
        closeAllOverlaysExcept(categoryMenuOverlay);
        categoryMenuOverlay.classList.add('open');
        displayCategories(allGroupData);
    });

    closeCategoryMenuBtn.addEventListener('click', () => {
        categoryMenuOverlay.classList.remove('open');
    });

    function displayCategories(groupsToDisplay) {
        categoryListEl.innerHTML = '';

        const allChannelsOption = document.createElement('li');
        allChannelsOption.innerHTML = `
                <div class="category-icon-display">
                    <i class="fas fa-grip-horizontal"></i>
                </div>
                <span class="category-name">${translations.en.all_channels_title}</span>
            `;
        allChannelsOption.dataset.categoryName = 'All';
        allChannelsOption.addEventListener('click', () => {
            switchChannelList('default');
            removeDynamicTabs();
            categoryMenuOverlay.classList.remove('open');
            allChannelsSection.scrollIntoView({ behavior: 'smooth' });
        });
        categoryListEl.appendChild(allChannelsOption);

        const activeGroups = groupsToDisplay.filter(group => (group.originalData.status || 'on') === 'on');
        activeGroups.sort((a, b) => (a.order || Infinity) - (b.order || Infinity));

        activeGroups.forEach(group => {
            const listItem = document.createElement('li');
            listItem.innerHTML = `
                    <div class="category-icon-display">
                        ${group.logo ? `<img src="${group.logo}" alt="${group.name} Logo">` : `<i class="fas fa-tv"></i>`}
                    </div>
                    <span class="category-name">${group.name}</span>
                `;
            listItem.dataset.categoryName = group.name;

            listItem.addEventListener('click', (e) => {
                const selectedCategory = e.currentTarget.dataset.categoryName;
                
                const filteredChannels = allChannelsCombined.filter(channel =>
                    channel.category === selectedCategory && (channel.status || 'on') === 'on'
                );
                
                displayAllChannels(filteredChannels);
                categoryMenuOverlay.classList.remove('open');
                allChannelsSection.scrollIntoView({ behavior: 'smooth' });

                removeDynamicTabs();
                displayChannelListTitles('category', selectedCategory);
                const categoryTab = document.querySelector(`.channel-list-titles h3[data-source-type="category-filter"][data-source-key="${selectedCategory}"]`);
                if (categoryTab) {
                    updateActiveChannelListTitle(categoryTab);
                }
            });
            categoryListEl.appendChild(listItem);
        });

        if (categoryListEl.children.length === 0) {
            const noCategoriesItem = document.createElement('li');
            noCategoriesItem.textContent = translations.en.no_categories_found;
            noCategoriesItem.style.color = '#a0a0a0';
            noCategoriesItem.style.gridColumn = '1 / -1';
            categoryListEl.appendChild(noCategoriesItem);
        }
    }

    searchIcon.addEventListener('click', () => {
        searchOverlay.style.display = 'flex';
        closeAllOverlaysExcept(searchOverlay);
        searchInput.focus();
        filterChannels('');
    });

    closeSearchBtn.addEventListener('click', () => {
        searchOverlay.style.display = 'none';
        searchInput.value = '';
        searchResultsList.innerHTML = '';
    });

    clearSearchBtn.addEventListener('click', () => {
        searchInput.value = '';
        filterChannels('');
    });

    searchInput.addEventListener('input', (e) => {
        const searchTerm = e.target.value.toLowerCase();
        filterChannels(searchTerm);
    });

    function filterChannels(searchTerm) {
        searchResultsList.innerHTML = '';

        const activeChannels = allChannelsCombined.filter(channel => (channel.status || 'on') === 'on');
        activeChannels.sort((a, b) => (a.order || Infinity) - (b.order || Infinity));

        if (activeChannels.length === 0) {
            const noChannelsItem = document.createElement('li');
            noChannelsItem.textContent = translations.en.no_channels_found;
            noChannelsItem.style.color = '#a0a0a0';
            searchResultsList.appendChild(noChannelsItem);
            return;
        }

        const filtered = activeChannels.filter(channel =>
            channel.name.toLowerCase().includes(searchTerm)
        );

        if (filtered.length === 0) {
            const noResultsItem = document.createElement('li');
            noResultsItem.textContent = translations.en.no_results_found;
            noResultsItem.style.color = '#a0a0a0';
            searchResultsList.appendChild(noResultsItem);
            return;
        }

        filtered.forEach(channel => {
            const listItem = document.createElement('li');
            const isPremium = channel.isPremium;

            listItem.innerHTML = `
                <div class="channel-icon-small">
                    ${channel.logo ? `<img src="${channel.logo}" alt="${channel.name} Logo" style="width: 100%; height: 100%; border-radius: 50%;">` : channel.name.charAt(0).toUpperCase()}
                </div>
                <span class="channel-name-search">${channel.name} ${isPremium ? '&#11088;' : ''}</span>
            `;
            listItem.dataset.src = channel.url;
            listItem.dataset.title = channel.name;
            listItem.dataset.id = channel.id;
            listItem.dataset.isPremium = isPremium;
            listItem.dataset.status = channel.status;
            listItem.dataset.category = channel.category;

            listItem.addEventListener('click', (e) => {
                const src = e.currentTarget.dataset.src;
                const title = e.currentTarget.dataset.title;
                const id = e.currentTarget.dataset.id;
                const isPremiumChannel = e.currentTarget.dataset.isPremium === 'true';
                const category = e.currentTarget.dataset.category;
                loadChannel(src, title, id, isPremiumChannel, category);
                searchOverlay.style.display = 'none';
            });
            searchResultsList.appendChild(listItem);
        });
    }

    titleBookmarkIcon.addEventListener('click', async () => {
        if (!currentChannelId) return;

        const channelToBookmark = allChannelsCombined.find(c => c.id === currentChannelId);
        if (!channelToBookmark) {
            window.alert(translations.en.channel_not_found_bookmark);
            return;
        }

        if ((channelToBookmark.status || 'on') === 'off') {
            window.alert(`Cannot bookmark "${channelToBookmark.name}". Its status is currently off.`);
            return;
        }

        const user = auth.currentUser;
        let storedBookmarks = JSON.parse(localStorage.getItem('userBookmarks') || '{}');

        if (user) {
            // Logged in user: Sync with Firebase
            const bookmarkChannelRef = db.ref(`user_bookmarks/${user.uid}/${currentChannelId}`);
            const snapshot = await bookmarkChannelRef.once('value');

            if (snapshot.exists()) {
                bookmarkChannelRef.remove()
                    .catch(error => console.error("Error removing bookmark from Firebase:", error));
                delete storedBookmarks[currentChannelId]; // Update local cache
            } else {
                bookmarkChannelRef.set(channelToBookmark)
                    .catch(error => console.error("Error setting bookmark to Firebase:", error));
                storedBookmarks[currentChannelId] = channelToBookmark; // Update local cache
            }
        } else {
            // Not logged in: Use only local storage
            if (storedBookmarks[currentChannelId]) {
                delete storedBookmarks[currentChannelId];
            } else {
                storedBookmarks[currentChannelId] = channelToBookmark;
            }
        }
        localStorage.setItem('userBookmarks', JSON.stringify(storedBookmarks));
        updateBookmarkButtonState(currentChannelId);
        displayBookmarkedChannels(); // Refresh bookmark list if open
    });


    function updateBookmarkButtonState(channelId) {
        if (!channelId) {
            titleBookmarkIcon.classList.remove('bookmarked');
            return;
        }
        const storedBookmarks = JSON.parse(localStorage.getItem('userBookmarks') || '{}');
        const isBookmarkedAndActive = storedBookmarks[channelId] && (storedBookmarks[channelId].status || 'on') === 'on';

        if (isBookmarkedAndActive) {
            titleBookmarkIcon.classList.add('bookmarked');
        } else {
            titleBookmarkIcon.classList.remove('bookmarked');
        }
    }

    bookmarkIcon.addEventListener('click', () => {
        bookmarkOverlay.style.display = 'flex';
        closeAllOverlaysExcept(bookmarkOverlay);
        displayBookmarkedChannels();
    });

    closeBookmarkBtn.addEventListener('click', () => {
        bookmarkOverlay.style.display = 'none';
    });

    function displayBookmarkedChannels() {
        bookmarkChannelsList.innerHTML = '';

        const storedBookmarks = JSON.parse(localStorage.getItem('userBookmarks') || '{}');
        let bookmarkedChannelsArray = Object.values(storedBookmarks);

        bookmarkedChannelsArray = bookmarkedChannelsArray.filter(channel => (channel.status || 'on') === 'on');
        bookmarkedChannelsArray.sort((a, b) => (a.order || Infinity) - (b.order || Infinity));


        if (bookmarkedChannelsArray.length === 0) {
            const noBookmarksItem = document.createElement('li');
            noBookmarksItem.textContent = translations.en.no_bookmarks_found;
            noBookmarksItem.style.color = '#a0a0a0';
            bookmarkChannelsList.appendChild(noBookmarksItem);
            return;
        }

        bookmarkedChannelsArray.forEach(channel => {
            const isPremium = channel.isPremium;

            const listItem = document.createElement('li');
            listItem.innerHTML = `
                <div class="channel-icon-small">
                    ${channel.logo ? `<img src="${channel.logo}" alt="${channel.name} Logo" style="width: 100%; height: 100%; border-radius: 50%;">` : channel.name.charAt(0).toUpperCase()}
                </div>
                <span class="channel-name-bookmark">${channel.name} ${isPremium ? '&#11088;' : ''}</span>
                <button class="remove-bookmark-btn" data-id="${channel.id}" title="${translations.en.remove_bookmark_title}">
                    <i class="fas fa-times"></i>
                </button>
            `;
            listItem.dataset.src = channel.url;
            listItem.dataset.title = channel.name;
            listItem.dataset.id = channel.id;
            listItem.dataset.isPremium = isPremium;
            listItem.dataset.status = channel.status;
            listItem.dataset.category = channel.category;


            listItem.addEventListener('click', (e) => {
                if (e.target.closest('.remove-bookmark-btn')) {
                    return;
                }
                const src = e.currentTarget.dataset.src;
                const title = e.currentTarget.dataset.title;
                const id = e.currentTarget.dataset.id;
                const isPremiumChannel = e.currentTarget.dataset.isPremium === 'true';
                const category = e.currentTarget.dataset.category;
                loadChannel(src, title, id, isPremiumChannel, category);
                bookmarkOverlay.style.display = 'none';
            });

            listItem.querySelector('.remove-bookmark-btn').addEventListener('click', (e) => {
                const channelIdToRemove = e.currentTarget.dataset.id;
                const user = auth.currentUser;
                let storedBookmarks = JSON.parse(localStorage.getItem('userBookmarks') || '{}');

                if (user) {
                    db.ref(`user_bookmarks/${user.uid}/${channelIdToRemove}`).remove()
                        .catch(error => console.error("Error removing bookmark from Firebase:", error));
                }
                delete storedBookmarks[channelIdToRemove];
                localStorage.setItem('userBookmarks', JSON.stringify(storedBookmarks));
                displayBookmarkedChannels(); // Refresh the displayed list immediately
                updateBookmarkButtonState(currentChannelId);
            });
            bookmarkChannelsList.appendChild(listItem);
        });
    }

    function listenForBookmarks() {
        userBookmarksRef.on('value', snapshot => {
            const firebaseBookmarks = snapshot.val() || {};
            const storedBookmarks = JSON.parse(localStorage.getItem('userBookmarks') || '{}');
            
            if (auth.currentUser) {
                // Merge Firebase bookmarks into local storage, preferring Firebase for logged-in users
                const mergedBookmarks = { ...storedBookmarks, ...firebaseBookmarks };
                localStorage.setItem('userBookmarks', JSON.stringify(mergedBookmarks));
            } else {
                // For non-logged-in users, we still rely on local storage,
                // but this listener won't update local storage from Firebase (as userBookmarksRef won't exist for anonymous)
                // This part primarily ensures `updateBookmarkButtonState` works based on local storage
            }
            
            if (bookmarkOverlay.style.display === 'flex') {
                displayBookmarkedChannels();
            }
            updateBookmarkButtonState(currentChannelId);
        }, error => {
            // If there's an error fetching from Firebase (e.g., no connection, or no user logged in)
            // we gracefully fall back to local storage without an alert, just log.
            console.error("Error fetching bookmarks from Firebase, falling back to local storage data:", error);
            const storedBookmarks = localStorage.getItem('userBookmarks');
            if (storedBookmarks) {
                if (bookmarkOverlay.style.display === 'flex') {
                    displayBookmarkedChannels();
                }
                updateBookmarkButtonState(currentChannelId);
            }
        });
    }


    eventIcon.addEventListener('click', () => {
        eventFullscreenOverlay.style.display = 'flex';
        closeAllOverlaysExcept(eventFullscreenOverlay);
        fetchEventData();
    });

    closeEventFullscreenBtn.addEventListener('click', () => {
        eventFullscreenOverlay.style.display = 'none';
        for (const intervalId in countdownIntervals) {
            clearInterval(countdownIntervals[intervalId]);
        }
        countdownIntervals = {};
    });

    async function fetchEventData() {
        eventGrid.innerHTML = `<div class="no-event-message">${translations.en.loading_event_data}</div>`;
        for (const intervalId in countdownIntervals) {
            clearInterval(countdownIntervals[intervalId]);
        }
        countdownIntervals = {};

        try {
            const snapshot = await eventsRef.once('value');
            const eventsData = snapshot.val();
            
            let events = [];
            if (eventsData) {
                events = Object.keys(eventsData).map(key => eventsData[key]);
            }

            if (!Array.isArray(events) || events.length === 0) {
                eventGrid.innerHTML = `<div class="no-event-message">${translations.en.no_events_found}</div>`;
                return;
            }

            events.sort((a, b) => {
                const dateA = new Date(a.startTime);
                const dateB = new Date(b.startTime);
                return dateA.getTime() - dateB.getTime();
            });

            eventGrid.innerHTML = '';

            events.forEach((event, index) => {
                const uniqueEventIdentifier = event.title ? event.title.replace(/\s/g, '_').toLowerCase() : `${event.team1Name}_vs_${event.team2Name}`.replace(/\s/g, '_').toLowerCase();
                const eventId = `event_${uniqueEventIdentifier}_${new Date(event.startTime).getTime()}`;
                
                renderEventCard(event, eventId);
            });

        } catch (error) {
            console.error("Failed to fetch event data:", error);
            eventGrid.innerHTML = `<div class="no-event-message">Failed to load event data. Please try again later.</div>`;
        }
    }

    function renderEventCard(event, eventId) {
        const { team1Logo, team1Name, team2Logo, team2Name, startTime, m3u8Link, title } = event;

        const [datePart, timePart] = startTime.split(' ');
        const [year, month, day] = datePart.split('-').map(Number);
        const [hours, minutes] = timePart.split(':').map(Number);
        
        const eventDate = new Date(year, month - 1, day, hours, minutes, 0);

        const eventCard = document.createElement('div');
        eventCard.classList.add('event-card');
        eventCard.innerHTML = `
            <div class="event-team-display">
                <div class="event-team">
                    <img src="${team1Logo}" alt="${team1Name} Logo">
                    <span class="event-team-name">${team1Name}</span>
                </div>
                <span class="event-vs">VS</span>
                <div class="event-team">
                    <img src="${team2Logo}" alt="${team2Name} Logo">
                    <span class="event-team-name">${team2Name}</span>
                </div>
            </div>
            <div class="event-title">${title || `${team1Name} vs ${team2Name}`}</div>
            <div class="event-countdown" id="countdown_${eventId}"></div>
            <button class="watch-match-btn" id="watchBtn_${eventId}">${translations.en.watch_match_button}</button>
        `;
        eventGrid.appendChild(eventCard);

        const countdownEl = document.getElementById(`countdown_${eventId}`);
        const watchMatchBtn = document.getElementById(`watchBtn_${eventId}`);

        const isEventPremium = (title || `${team1Name} vs ${team2Name}`).includes('VIP');

        watchMatchBtn.addEventListener('click', () => {
            loadChannel(m3u8Link, title || `${team1Name} vs ${team2Name}`, eventId, isEventPremium, null);
            eventFullscreenOverlay.style.display = 'none';
            for (const intervalId in countdownIntervals) {
                clearInterval(countdownIntervals[intervalId]);
            }
            countdownIntervals = {};
        });

        updateCountdown(eventDate.getTime(), countdownEl, watchMatchBtn, eventId, m3u8Link, title || `${team1Name} vs ${team2Name}`);

        countdownIntervals[eventId] = setInterval(() => {
            updateCountdown(eventDate.getTime(), countdownEl, watchMatchBtn, eventId, m3u8Link, title || `${team1Name} vs ${team2Name}`);
        }, 1000);
    }

    function updateCountdown(matchStartTimeMs, countdownEl, buttonEl, eventId, m3u8Link, title) {
        const now = new Date().getTime();
        const distance = matchStartTimeMs - now;

        if (distance <= 0) {
            countdownEl.innerHTML = "Match Live Now!";
            countdownEl.classList.add('finished');
            buttonEl.textContent = translations.en.watch_match_button;
            buttonEl.disabled = false;
            
            if (countdownIntervals[eventId]) {
                clearInterval(countdownIntervals[eventId]);
                delete countdownIntervals[eventId];
            }
            return;
        }

        const days = Math.floor(distance / (1000 * 60 * 60 * 24));
        const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((distance % (1000 * 60)) / 1000);

        countdownEl.innerHTML = `${days}d ${hours}h ${minutes}m ${seconds}s`;
        countdownEl.classList.remove('finished');
        buttonEl.textContent = "Starts Soon";
        buttonEl.disabled = true;
    }


    function closeAllOverlays() {
        const overlays = [addLinkOverlay, searchOverlay, bookmarkOverlay, chatFullscreenOverlay, categoryMenuOverlay, usernameOverlay, eventFullscreenOverlay, profileOverlay, userChatOverlay, customAlertOverlay, fullScreenEmbedOverlay, introVideoOverlay, internetStatusOverlay];
        overlays.forEach(overlay => {
            if (overlay === categoryMenuOverlay) {
                overlay.classList.remove('open');
            } else if (overlay === customAlertOverlay) {
                overlay.classList.remove('visible');
            } else {
                overlay.style.display = 'none';
            }
            if (overlay === eventFullscreenOverlay) {
                for (const intervalId in countdownIntervals) {
                    clearInterval(countdownIntervals[intervalId]);
                }
                countdownIntervals = {};
            }
            if (overlay === profileOverlay && profileCountdownInterval) {
                clearInterval(profileCountdownInterval);
                profileCountdownInterval = null;
            }
            if (overlay === userChatOverlay) {
                if (userChatMessagesEl._firebaseListener) {
                    userChatMessagesEl._firebaseListener.off('child_added');
                    userChatMessagesEl._firebaseListener = null;
                    currentPrivateChatUser = null;
                }
                clearTypingStatusListeners();
            }
            if (overlay === chatFullscreenOverlay) {
                chatRef.off('child_added');
                if (db._privateChatFriendListListener) {
                    db._privateChatFriendListListener.off();
                    db._privateChatFriendListListener = null;
                }
                if (activeStatusUpdateInterval) {
                    clearInterval(activeStatusUpdateInterval);
                    activeStatusUpdateInterval = null;
                }
            }
            if (overlay === fullScreenEmbedOverlay) { // Clear iframe source when closing
                fullScreenEmbedIframe.src = '';
            }
            // Clear intro video related intervals and elements
            if (overlay === introVideoOverlay) {
                introVideoPlayer.pause();
                introVideoPlayer.currentTime = 0;
                introVideoPlayer.controls = false;
                if (introVideoAdCountdownInterval) clearInterval(introVideoAdCountdownInterval);
                document.getElementById('introAdButtonContainer').innerHTML = '';
                document.getElementById('introAdButtonContainer').style.display = 'none';
            }
        });
    }

    function closeAllOverlaysExcept(exceptionOverlay) {
        const overlays = [addLinkOverlay, searchOverlay, bookmarkOverlay, chatFullscreenOverlay, categoryMenuOverlay, usernameOverlay, eventFullscreenOverlay, profileOverlay, userChatOverlay, customAlertOverlay, fullScreenEmbedOverlay, introVideoOverlay, internetStatusOverlay];
        overlays.forEach(overlay => {
            if (overlay !== exceptionOverlay) {
                if (overlay === categoryMenuOverlay) {
                    overlay.classList.remove('open');
                } else if (overlay === customAlertOverlay) {
                    overlay.classList.remove('visible');
                } else {
                    overlay.style.display = 'none';
                }
                if (overlay === eventFullscreenOverlay) {
                    for (const intervalId in countdownIntervals) {
                        clearInterval(countdownIntervals[intervalId]);
                    }
                    countdownIntervals = {};
                }
                if (overlay === profileOverlay && profileCountdownInterval) {
                    clearInterval(profileCountdownInterval);
                    profileCountdownInterval = null;
                }
                if (overlay === userChatOverlay) {
                    if (userChatMessagesEl._firebaseListener) {
                        userChatMessagesEl._firebaseListener.off('child_added');
                        userChatMessagesEl._firebaseListener = null;
                        currentPrivateChatUser = null;
                    }
                    clearTypingStatusListeners();
                }
                if (overlay === chatFullscreenOverlay) {
                    chatRef.off('child_added');
                    if (db._privateChatFriendListListener) {
                        db._privateChatFriendListListener.off();
                        db._privateChatFriendListListener = null;
                    }
                    if (activeStatusUpdateInterval) {
                        clearInterval(activeStatusUpdateInterval);
                        activeStatusUpdateInterval = null;
                    }
                }
                if (overlay === fullScreenEmbedOverlay) { // Clear iframe source when closing
                    fullScreenEmbedIframe.src = '';
                }
                // Clear intro video related intervals and elements
                if (overlay === introVideoOverlay) {
                    introVideoPlayer.pause();
                    introVideoPlayer.currentTime = 0;
                    introVideoPlayer.controls = false;
                    if (introVideoAdCountdownInterval) clearInterval(introVideoAdCountdownInterval);
                    document.getElementById('introAdButtonContainer').innerHTML = '';
                    document.getElementById('introAdButtonContainer').style.display = 'none';
                }
            }
        });
    }

    profileOpenBtn.addEventListener('click', () => {
        closeAllOverlaysExcept(profileOverlay);
        profileOverlay.style.display = 'flex';
        
        if (auth.currentUser) {
            displayUserProfile(auth.currentUser);
        } else {
            showLogin();
        }
    });

    closeProfileBtn.addEventListener('click', () => {
        profileOverlay.style.display = 'none';
        if (profileCountdownInterval) {
            clearInterval(profileCountdownInterval);
            profileCountdownInterval = null;
        }
    });

    showRegisterBtn.addEventListener('click', showRegister);
    showLoginBtn.addEventListener('click', showLogin);

    function showLogin() {
        loginContainer.style.display = 'block';
        registerContainer.style.display = 'none';
        userProfileContainer.style.display = 'none';
        loginEmailInput.value = '';
        loginPasswordInput.value = '';
        registerProgressBar.style.display = 'none';
        registerSuccessMessage.style.display = 'none';
    }

    function showRegister() {
        loginContainer.style.display = 'none';
        registerContainer.style.display = 'block';
        userProfileContainer.style.display = 'none';
        registerNameInput.value = '';
        registerEmailInput.value = '';
        registerPasswordInput.value = '';
        registerPhoneInput.value = '';
        registerPhotoURLInput.value = '';
        registerProgressBar.style.display = 'none';
        registerSuccessMessage.style.display = 'none';
        registerBtn.style.display = 'block';
    }
    
    function updateProfileCountdown(targetTimestamp, element, prefix, isExpiredMessage) {
        const now = new Date().getTime();
        let distance = targetTimestamp - now;

        if (distance <= 0) {
            element.style.color = isExpiredMessage.includes('Ban') ? '#ff0000' : '#ffcc00';
            element.innerHTML = `${isExpiredMessage} <i class="fas fa-times-circle"></i>`;
            return;
        }
        
        const days = Math.floor(distance / (1000 * 60 * 60 * 24));
        const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((distance % (1000 * 60)) / 1000);

        element.textContent = `${prefix} ${days}d ${hours}h ${minutes}m ${seconds}s`;
    }

    async function displayUserProfile(user) {
        loginContainer.style.display = 'none';
        registerContainer.style.display = 'none';
        userProfileContainer.style.display = 'block';

        // Remove existing Get Premium text/button if it exists
        const existingGetPremiumText = document.getElementById('getPremiumText');
        if (existingGetPremiumText) {
            existingGetPremiumText.remove();
        }
        // Remove existing Add Balance text/button if it exists
        const existingAddBalanceText = document.getElementById('addBalanceText');
        if (existingAddBalanceText) {
            existingAddBalanceText.remove();
        }

        if (profileCountdownInterval) {
            clearInterval(profileCountdownInterval);
        }

        let userData = null;
        try {
            const snapshot = await userProfilesRef.child(user.uid).once('value');
            userData = snapshot.val();
        } catch (error) {
            console.error("Error fetching user profile data:", error);
        }

        if (user.photoURL) {
            profileImage.src = user.photoURL;
            profileImage.style.display = 'block';
            defaultProfileIcon.style.display = 'none';
        } else if (userData?.photoURL) {
            profileImage.src = userData.photoURL;
            profileImage.style.display = 'block';
            defaultProfileIcon.style.display = 'none';
        } else {
            profileImage.style.display = 'none';
            defaultProfileIcon.style.display = 'block';
        }
        
        profileNameSpan.textContent = userData?.name || user.displayName || 'N/A';
        profileEmailSpan.textContent = user.email;
        profilePhoneSpan.textContent = userData?.phone || 'N/A';
        
        const now = new Date().getTime();
        
        const premiumEndDate = parseDateString(userData?.premiumUntil);
        const banEndDate = parseDateString(userData?.bannedUntil);
        
        const isPremiumActiveCheck = userData?.isPremium && premiumEndDate?.getTime() > now;
        const isBannedActive = userData?.isBanned && banEndDate?.getTime() > now;

        isPremiumUser = isPremiumActiveCheck; // Update the global premium user flag
        
        // Update Premium Status and text
        if (isPremiumActiveCheck) {
            profilePremiumStatusSpan.style.color = '#00ff00';
            profilePremiumStatusSpan.innerHTML = `Active: <span id="premiumCountdown"></span> <i class="fas fa-check-circle"></i>`;
            updateProfileCountdown(premiumEndDate.getTime(), document.getElementById('premiumCountdown'), '', translations.en.premium_status_expired);
            premiumStatusHeader.style.display = 'block';
        } else {
            profilePremiumStatusSpan.style.color = '#ffcc00';
            profilePremiumStatusSpan.innerHTML = `No <i class="fas fa-times-circle"></i>`;
            premiumStatusHeader.style.display = 'none';
            
            const getPremiumText = document.createElement('span');
            getPremiumText.id = 'getPremiumText';
            getPremiumText.className = 'profile-action-text';
            getPremiumText.textContent = translations.en.get_premium_text;
            
            const premiumStatusParagraph = profilePremiumStatusSpan.closest('p');
            if (premiumStatusParagraph) {
                premiumStatusParagraph.appendChild(getPremiumText);
            }
            
            getPremiumText.addEventListener('click', async () => {
                try {
                    const snapshot = await dukaneJawRef.once('value');
                    const dukaneJawData = snapshot.val();
                    if (dukaneJawData && dukaneJawData.redirect_link) {
                        openFullScreenEmbed(dukaneJawData.redirect_link); // Use new function
                    } else {
                        window.alert("Premium link not configured. Please contact support.");
                    }
                } catch (error) {
                    console.error("Error fetching premium link:", error);
                    window.alert("Failed to get premium link. Please try again later.");
                }
            });
        }

        // Display Balance and Add text
        const userBalance = userData?.balance?.amount || 0;
        profileBalanceAmountSpan.textContent = userBalance;

        const addBalanceText = document.createElement('span');
        addBalanceText.id = 'addBalanceText';
        addBalanceText.className = 'profile-action-text';
        addBalanceText.textContent = translations.en.add_balance_text;
        
        const balanceStatusParagraph = profileBalanceAmountSpan.closest('p');
        if (balanceStatusParagraph) {
            balanceStatusParagraph.appendChild(addBalanceText);
        }

        addBalanceText.addEventListener('click', async () => {
            try {
                const snapshot = await dukaneJawRef.once('value');
                const dukaneJawData = snapshot.val();
                if (dukaneJawData && dukaneJawData.redirect_link) {
                    openFullScreenEmbed(dukaneJawData.redirect_link); // Use new function
                } else {
                    window.alert("Add balance link not configured. Please contact support.");
                }
            } catch (error) {
                console.error("Error fetching add balance link:", error);
                window.alert("Failed to get add balance link. Please try again later.");
            }
        });


        // Update Ban Status
        if (isBannedActive) {
            profileBanStatusSpan.style.color = '#ff0000';
            profileBanStatusSpan.innerHTML = `You Banned for <span id="banCountdown"></span> <i class="fas fa-times-circle"></i>`;
            updateProfileCountdown(banEndDate.getTime(), document.getElementById('banCountdown'), '', translations.en.ban_status_expired);
        } else {
            profileBanStatusSpan.style.color = '#00ff00';
            profileBanStatusSpan.innerHTML = `No <i class="fas fa-check-circle"></i>`;
        }
        
        profileCountdownInterval = setInterval(() => {
            const currentNow = new Date().getTime();
            userProfilesRef.child(user.uid).once('value').then(latestSnapshot => {
                const latestUserData = latestSnapshot.val();
                const latestPremiumEndDate = parseDateString(latestUserData?.premiumUntil);
                const latestBanEndDate = parseDateString(latestUserData?.bannedUntil);
                const latestUserBalance = latestUserData?.balance?.amount || 0;

                const latestIsPremiumActive = latestUserData?.isPremium && latestPremiumEndDate?.getTime() > currentNow;
                const latestIsBannedActive = latestUserData?.isBanned && latestBanEndDate?.getTime() > currentNow;

                profileBalanceAmountSpan.textContent = latestUserBalance; // Update balance dynamically
                isPremiumUser = latestIsPremiumActive; // Update the global premium user flag

                const premiumCountdownEl = document.getElementById('premiumCountdown');
                if (latestIsPremiumActive) {
                    if (premiumCountdownEl) {
                        updateProfileCountdown(latestPremiumEndDate.getTime(), premiumCountdownEl, '', translations.en.premium_status_expired);
                    } else {
                        profilePremiumStatusSpan.style.color = '#00ff00';
                        profilePremiumStatusSpan.innerHTML = `Active: <span id="premiumCountdown"></span> <i class="fas fa-check-circle"></i>`;
                        updateProfileCountdown(latestPremiumEndDate.getTime(), document.getElementById('premiumCountdown'), '', translations.en.premium_status_expired);
                    }
                    const getPremiumText = document.getElementById('getPremiumText');
                    if (getPremiumText) getPremiumText.remove();
                    premiumStatusHeader.style.display = 'block';

                } else {
                    if (premiumCountdownEl) premiumCountdownEl.remove();
                    profilePremiumStatusSpan.style.color = '#ffcc00';
                    profilePremiumStatusSpan.innerHTML = `No <i class="fas fa-times-circle"></i>`;
                    premiumStatusHeader.style.display = 'none';
                    if (!document.getElementById('getPremiumText')) {
                        const getPremiumText = document.createElement('span');
                        getPremiumText.id = 'getPremiumText';
                        getPremiumText.className = 'profile-action-text';
                        getPremiumText.textContent = translations.en.get_premium_text;
                        profilePremiumStatusSpan.closest('p')?.appendChild(getPremiumText);
                        getPremiumText.addEventListener('click', async () => {
                            try {
                                const snapshot = await dukaneJawRef.once('value');
                                const dukaneJawData = snapshot.val();
                                if (dukaneJawData && dukaneJawData.redirect_link) {
                                    openFullScreenEmbed(dukaneJawData.redirect_link); // Use new function
                                } else {
                                    window.alert("Premium link not configured. Please contact support.");
                                }
                            } catch (error) {
                                console.error("Error fetching premium link:", error);
                                window.alert("Failed to get premium link. Please try again later.");
                            }
                        });
                    }
                }

                const banCountdownEl = document.getElementById('banCountdown');
                if (latestIsBannedActive) {
                    if (banCountdownEl) {
                        updateProfileCountdown(latestBanEndDate.getTime(), banCountdownEl, '', translations.en.ban_status_expired);
                    } else {
                        profileBanStatusSpan.style.color = '#ff0000';
                        profileBanStatusSpan.innerHTML = `You Banned for <span id="banCountdown"></span> <i class="fas fa-times-circle"></i>`;
                        updateProfileCountdown(banEndDate.getTime(), document.getElementById('banCountdown'), '', translations.en.ban_status_expired);
                    }
                } else {
                    if (banCountdownEl) banCountdownEl.remove();
                    profileBanStatusSpan.style.color = '#00ff00';
                    profileBanStatusSpan.innerHTML = `No <i class="fas fa-check-circle"></i>`;
                }

                if (!latestIsPremiumActive && !latestIsBannedActive && profileCountdownInterval) {
                    clearInterval(profileCountdownInterval);
                    profileCountdownInterval = null;
                }
            }).catch(error => {
                console.error("Error updating profile countdowns:", error);
            });
        }, 1000);
    }

    loginBtn.addEventListener('click', async () => {
        const email = loginEmailInput.value;
        const password = loginPasswordInput.value;

        if (!email || !password) {
            window.alert('Please enter both email and password.');
            return;
        }

        try {
            await auth.signInWithEmailAndPassword(email, password);
        } catch (error) {
            console.error("Login failed:", error);
            window.alert(`Login failed: ${error.message}`);
        }
    });

    registerBtn.addEventListener('click', async () => {
        const name = registerNameInput.value.trim();
        const email = registerEmailInput.value.trim();
        const password = registerPasswordInput.value.trim();
        const phone = registerPhoneInput.value.trim();
        const photoURL = registerPhotoURLInput.value.trim();

        if (!email || !password) {
            window.alert('Please enter email and password to register.');
            return;
        }
        
        registerBtn.style.display = 'none';
        registerProgressBar.style.display = 'block';

        try {
            const userCredential = await auth.createUserWithEmailAndPassword(email, password);
            const user = userCredential.user;

            await user.updateProfile({
                displayName: name || email.split('@')[0],
                photoURL: photoURL || null
            });

            await userProfilesRef.child(user.uid).set({
                name: user.displayName,
                email: email,
                phone: phone || null,
                photoURL: user.photoURL || null,
                isBanned: false,
                bannedUntil: "00-00-0000",
                isPremium: false,
                premiumUntil: "00-00-0000",
                balance: { // Initialize balance to 0
                    amount: 0,
                    last_updated: firebase.database.ServerValue.TIMESTAMP
                }
            });
            
            registerProgressBar.style.display = 'none';
            registerSuccessMessage.style.display = 'block';

            setTimeout(() => {
                registerSuccessMessage.style.display = 'none';
                closeAllOverlays();
            }, 2000);

        } catch (error) {
            console.error("Registration failed:", error);
            window.alert(`Registration failed: ${error.message}`);

            registerProgressBar.style.display = 'none';
            registerBtn.style.display = 'block';
        }
    });

    logoutBtn.addEventListener('click', async () => {
        try {
            await auth.signOut();
        } catch (error) {
            console.error("Logout failed:", error);
            window.alert(`Logout failed: ${error.message}`);
        }
    });

    async function loadAdsConditionally() {
        const existingAdScripts = document.querySelectorAll('script[data-ad-type="popunder"]');
        existingAdScripts.forEach(script => script.remove());

        try {
            const adsSnapshot = await adsConfigRef.once('value');
            const adsConfig = adsSnapshot.val();

            if (adsConfig && adsConfig.status === 'on' && adsConfig.popunder_ad_code) {
                const user = auth.currentUser;
                let shouldLoadAd = false;

                if (!user) {
                    shouldLoadAd = true;
                } else {
                    const userProfileSnapshot = await userProfilesRef.child(user.uid).once('value');
                    const userData = userProfileSnapshot.val() || {};
                    const premiumUntilDate = parseDateString(userData.premiumUntil);
                    const isPremiumActive = userData.isPremium && premiumUntilDate && premiumUntilDate.getTime() > Date.now();

                    if (!isPremiumActive) {
                        shouldLoadAd = true;
                    } else {}
                }

                if (shouldLoadAd) {
                    const script = document.createElement('script');
                    script.type = 'text/javascript';
                    script.innerHTML = adsConfig.popunder_ad_code;
                    script.setAttribute('data-ad-type', 'popunder');
                    document.head.appendChild(script);
                }
            } else {}
        } catch (error) {
            console.error("Error loading conditional ads:", error);
        }
    }


    auth.onAuthStateChanged(async user => {
        if (user) {
            currentUserID = user.uid;
            // Set up listener for current user's profile
            if (currentUserProfileListener) {
                userProfilesRef.child(currentUserID).off('value', currentUserProfileListener);
            }
            currentUserProfileListener = userProfilesRef.child(currentUserID).on('value', snapshot => {
                const userData = snapshot.val() || {};
                // Update global photoURL
                currentUserPhotoURL = userData.photoURL || null;
                // Update global display name
                currentUsername = userData.name || user.displayName || user.email.split('@')[0];

                // Re-display profile and update all avatars in UI
                displayUserProfile(user); // This will update profile overlay and set isPremiumUser
                updateAllUserAvatarsInUI(); // This will update chat avatars and friend list
            }, error => {
                console.error("Error listening for current user profile changes:", error);
                // Fallback to user.photoURL if DB fetch fails
                currentUserPhotoURL = user.photoURL || null;
                currentUsername = user.displayName || user.email.split('@')[0];
                displayUserProfile(user);
                updateAllUserAvatarsInUI();
            });

            const userPresenceRef = db.ref('presence/' + user.uid);
            userPresenceRef.onDisconnect().remove()
                .catch(error => console.error("Error setting onDisconnect for presence:", error));
            userPresenceRef.set({
                displayName: currentUsername, // Use updated currentUsername
                photoURL: currentUserPhotoURL, // Use updated currentUserPhotoURL
                last_active: firebase.database.ServerValue.TIMESTAMP
            })
                .catch(error => console.error("Error setting user presence:", error));

            loadAdsConditionally();
            loadChatMessages();
            listenForPrivateMessagesForFriendList(user.uid);
            usernameOverlay.style.display = 'none';

        } else {
            // User logged out
            if (currentUserID) {
                db.ref('presence/' + currentUserID).remove()
                    .catch(error => console.error("Error removing old user presence:", error));
                // Turn off the user profile listener when logged out
                if (currentUserProfileListener) {
                    userProfilesRef.child(currentUserID).off('value', currentUserProfileListener);
                    currentUserProfileListener = null;
                }
                currentUserID = '';
            }
            showLogin();
            
            currentUsername = '';
            currentUserPhotoURL = '';
            premiumStatusHeader.style.display = 'none';
            isPremiumUser = false; // Reset premium user flag on logout

            if (profileCountdownInterval) {
                clearInterval(profileCountdownInterval);
                profileCountdownInterval = null;
            }

            chatRef.off('child_added');
            fullscreenChatMessagesEl.innerHTML = '';

            privateChatHistory = {};
            if (db._privateChatFriendListListener) {
                db._privateChatFriendListListener.off();
                db._privateChatFriendListListener = null;
            }
            if (activeStatusUpdateInterval) {
                clearInterval(activeStatusUpdateInterval);
                activeStatusUpdateInterval = null;
            }
            friendListContainer.innerHTML = '';
            clearTypingStatusListeners();

            loadAdsConditionally();
        }
    });

    function displayFriendList() {
        friendListContainer.innerHTML = '';

        const user = auth.currentUser;
        if (!user) {
            friendListContainer.textContent = translations.en.no_friends_yet;
            friendListContainer.style.color = '#a0a0a0';
            friendListContainer.style.textAlign = 'center';
            return;
        }

        const friendIds = Object.keys(privateChatHistory).filter(uid => uid !== user.uid);

        if (friendIds.length === 0) {
            const noFriendsMessage = document.createElement('div');
            noFriendsMessage.classList.add('no-event-message');
            noFriendsMessage.textContent = translations.en.no_friends_yet;
            friendListContainer.appendChild(noFriendsMessage);
            return;
        }

        friendIds.sort((a, b) => {
            const msgA = privateChatHistory[a].lastMessage;
            const msgB = privateChatHistory[b].lastMessage;
            const timeA = msgA ? msgA.timestamp : 0;
            const timeB = msgB ? msgB.timestamp : 0;
            return timeB - timeA;
        });

        friendIds.forEach(friendUid => {
            const friendData = privateChatHistory[friendUid];
            const lastActiveTimestamp = onlineUsers[friendUid]?.last_active || null;
            const activeStatus = getActiveStatusText(lastActiveTimestamp);

            const friendListItem = document.createElement('div');
            friendListItem.classList.add('friend-list-item');
            friendListItem.dataset.uid = friendUid;
            friendListItem.dataset.displayName = friendData.displayName;
            friendListItem.dataset.photoUrl = friendData.photoURL || '';

            friendListItem.innerHTML = `
                <div class="friend-avatar">
                    ${friendData.photoURL ? `<img src="${friendData.photoURL}" alt="${friendData.displayName}">` : `<i class="fas fa-user-circle"></i>`}
                    ${activeStatus.class === 'active-now' ? '<div class="online-indicator"></div>' : ''}
                </div>
                <div class="friend-info">
                    <div class="friend-name">${friendData.displayName}</div>
                    <div class="friend-last-message">${friendData.lastMessage ? friendData.lastMessage.text : 'No messages yet'}</div>
                    <div class="friend-status-text ${activeStatus.class}">
                        ${activeStatus.text}
                    </div>
                </div>
            `;
            
            friendListItem.addEventListener('click', () => {
                openUserChat(friendListItem.dataset.uid, friendListItem.dataset.displayName, friendListItem.dataset.photoUrl);
            });

            friendListContainer.appendChild(friendListItem);
        });
    }

    function listenForPrivateMessagesForFriendList(myUid) {
        if (db._privateChatFriendListListener) {
            db._privateChatFriendListListener.off();
        }

        const privateMessagesRef = hugaMaraRef;
        
        const listener = privateMessagesRef.on('child_added', (snapshot) => {
            const roomId = snapshot.key;
            const roomUsers = roomId.split('_');
            
            if (roomUsers.includes(myUid)) {
                const otherUid = roomUsers.find(uid => uid !== myUid);
                if (otherUid) {
                    snapshot.ref.child('lastMessage').on('value', (lastMessageSnapshot) => {
                        const lastMessage = lastMessageSnapshot.val();
                        if (lastMessage) {
                            snapshot.ref.child(`participants/${otherUid}`).once('value').then(participantSnapshot => {
                                const participantData = participantSnapshot.val();
                                if (participantData) {
                                    privateChatHistory[otherUid] = {
                                        displayName: participantData.displayName,
                                        photoURL: participantData.photoURL,
                                        lastMessage: lastMessage,
                                        uid: otherUid
                                    };
                                } else {
                                    privateChatHistory[otherUid] = {
                                        displayName: privateChatHistory[otherUid]?.displayName || 'Unknown User',
                                        photoURL: privateChatHistory[otherUid]?.photoURL || null,
                                        lastMessage: lastMessage,
                                        uid: otherUid
                                    };
                                }
                                if (chatFullscreenOverlay.style.display === 'flex' && friendListTab.classList.contains('active-chat-tab')) {
                                    displayFriendList();
                                }
                            }).catch(error => console.error("Error fetching participant data for private chat:", error));
                        }
                    }, error => console.error("Error listening for last private message:", error));
                }
            }
        }, error => console.error("Error listening for private chat rooms:", error));
        db._privateChatFriendListListener = privateMessagesRef;
    }

    // Internet connection status handling
    function checkInternetStatus() {
        if (navigator.onLine) {
            internetStatusOverlay.style.display = 'none';
        } else {
            internetStatusOverlay.style.display = 'flex';
        }
    }

    // Initial check on load
    checkInternetStatus();

    // Listen for online/offline events
    window.addEventListener('online', checkInternetStatus);
    window.addEventListener('offline', checkInternetStatus);

</script>

</body>
</html>